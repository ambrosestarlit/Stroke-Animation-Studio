<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Stroke Studio">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1a1a2e">
<title>Stroke Animation Studio</title>
<script>
// PWA: ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ â†’ ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ â†’ Service Workerï¼ˆã™ã¹ã¦ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰
(function(){
  function makeIcon(sz,bg,fg){
    const c=document.createElement('canvas');c.width=sz;c.height=sz;
    const x=c.getContext('2d');
    // èƒŒæ™¯
    x.fillStyle=bg;x.beginPath();x.roundRect(0,0,sz,sz,sz*0.18);x.fill();
    // ãƒšãƒ³ã‚¢ã‚¤ã‚³ãƒ³
    const m=sz*0.15;const s=sz-m*2;
    x.save();x.translate(m+s*0.5,m+s*0.5);x.rotate(-Math.PI/4);x.translate(-s*0.12,-s*0.4);
    // ãƒšãƒ³è»¸
    x.fillStyle=fg;x.fillRect(-s*0.06,0,s*0.12,s*0.55);
    // ãƒšãƒ³å…ˆ
    x.beginPath();x.moveTo(-s*0.06,s*0.55);x.lineTo(s*0.06,s*0.55);x.lineTo(0,s*0.72);x.closePath();x.fill();
    // æ˜Ÿãƒãƒ¼ã‚¯
    x.restore();
    x.fillStyle='#e94560';x.font=`bold ${sz*0.22}px sans-serif`;x.textAlign='right';x.textBaseline='top';
    x.fillText('âœ¦',sz-m*0.6,m*0.4);
    return c.toDataURL('image/png');
  }
  const icon192=makeIcon(192,'#1a1a2e','#eaeaea');
  const icon512=makeIcon(512,'#1a1a2e','#eaeaea');

  // apple-touch-icon
  const al=document.createElement('link');al.rel='apple-touch-icon';al.href=icon192;document.head.appendChild(al);

  // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ
  const manifest={
    name:'Stroke Animation Studio',short_name:'Stroke Studio',
    start_url:'./',display:'standalone',orientation:'landscape',
    background_color:'#1a1a2e',theme_color:'#1a1a2e',
    icons:[
      {src:icon192,sizes:'192x192',type:'image/png'},
      {src:icon512,sizes:'512x512',type:'image/png',purpose:'any maskable'}
    ]
  };
  const mb=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  const ml=document.createElement('link');ml.rel='manifest';ml.href=URL.createObjectURL(mb);document.head.appendChild(ml);

  // Service Worker
  const swCode=`
    const CACHE='sas-v1';
    self.addEventListener('install',e=>{self.skipWaiting();});
    self.addEventListener('activate',e=>{e.waitUntil(clients.claim());});
    self.addEventListener('fetch',e=>{
      e.respondWith(
        caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
          if(res.ok&&e.request.method==='GET'){
            const c=res.clone();
            caches.open(CACHE).then(cache=>cache.put(e.request,c));
          }
          return res;
        }).catch(()=>caches.match(e.request)))
      );
    });
  `;
  const swb=new Blob([swCode],{type:'application/javascript'});
  const swUrl=URL.createObjectURL(swb);
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register(swUrl,{scope:'./'}).catch(()=>{});
  }
})();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
:root {
  --bg-primary:#1a1a2e;--bg-secondary:#16213e;--bg-tertiary:#0f3460;
  --bg-panel:#1c1c3a;--bg-input:#252547;
  --accent:#e94560;--accent-hover:#ff6b81;
  --text-primary:#eaeaea;--text-secondary:#a0a0c0;--text-muted:#6a6a8a;
  --border:#2a2a4a;--border-light:#3a3a5a;
  --success:#4ecdc4;--warning:#f9a825;
  --layer-color-1:#e94560;--layer-color-2:#4ecdc4;
  --layer-color-3:#f9a825;--layer-color-4:#a855f7;
  --draft-color-1:#555580;--draft-color-2:#555580;--draft-color-3:#555580;--draft-color-4:#555580;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI','Meiryo',sans-serif;background:var(--bg-primary);color:var(--text-primary);overflow:hidden;height:100vh;user-select:none;}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:var(--bg-primary);}
::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px;}

#header{display:flex;align-items:center;height:36px;background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:0 10px;gap:5px;}
#header .app-title{font-size:13px;font-weight:700;color:var(--accent);margin-right:12px;}
.header-btn{background:transparent;border:1px solid var(--border);color:var(--text-secondary);padding:3px 10px;font-size:11px;border-radius:3px;cursor:pointer;white-space:nowrap;}
.header-btn:hover{background:var(--bg-tertiary);color:var(--text-primary);}
.header-sep{width:1px;height:20px;background:var(--border);margin:0 3px;}
#project-name-input{background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);padding:3px 8px;font-size:11px;border-radius:3px;width:140px;}
#project-name-input::placeholder{color:var(--text-muted);}

#main-layout{display:flex;height:calc(100vh - 36px);}

#toolbar{width:44px;background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:8px 0;gap:2px;}
.tool-btn{width:34px;height:34px;background:transparent;border:none;border-radius:4px;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;position:relative;}
.tool-btn:hover{background:var(--bg-input);color:var(--text-primary);}
.tool-btn.active{background:var(--accent);color:#fff;}
.tool-btn svg{width:18px;height:18px;}
.tool-btn .shortcut{position:absolute;bottom:1px;right:2px;font-size:7px;color:var(--text-muted);pointer-events:none;}
.tool-btn.active .shortcut{color:rgba(255,255,255,0.6);}
.tool-sep{width:28px;height:1px;background:var(--border);margin:4px 0;}
#pen-settings{display:flex;flex-direction:column;align-items:center;gap:4px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);}
#stroke-point-settings{display:flex;flex-direction:column;align-items:center;gap:4px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);}
#stroke-point-settings label{font-size:9px;color:var(--text-muted);}
#stroke-point-val{font-size:10px;color:var(--text-secondary);}
#stroke-point-slider{width:30px;writing-mode:vertical-lr;direction:rtl;-webkit-appearance:none;appearance:none;background:transparent;cursor:pointer;height:80px;}
#stroke-point-slider::-webkit-slider-runnable-track{width:4px;background:var(--border-light);border-radius:2px;}
#stroke-point-slider::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--accent);border-radius:50%;margin-left:-4px;}
#pen-settings label{font-size:9px;color:var(--text-muted);}
#pen-size-val{font-size:10px;color:var(--text-secondary);}
#pen-smooth-val{font-size:10px;color:var(--text-secondary);}
#pen-size{width:30px;writing-mode:vertical-lr;direction:rtl;-webkit-appearance:none;appearance:none;background:transparent;cursor:pointer;height:80px;}
#pen-smooth{width:30px;writing-mode:vertical-lr;direction:rtl;-webkit-appearance:none;appearance:none;background:transparent;cursor:pointer;height:60px;}
#pen-size::-webkit-slider-runnable-track{width:4px;background:var(--border-light);border-radius:2px;}
#pen-smooth::-webkit-slider-runnable-track{width:4px;background:var(--border-light);border-radius:2px;}
#pen-size::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--accent);border-radius:50%;margin-left:-4px;}
#pen-smooth::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--accent);border-radius:50%;margin-left:-4px;}
#pen-color{width:28px;height:28px;border:2px solid var(--border-light);border-radius:4px;cursor:pointer;background:#000;padding:0;}
#pen-color::-webkit-color-swatch-wrapper{padding:0;}
#pen-color::-webkit-color-swatch{border:none;border-radius:2px;}

#canvas-area{flex:1;position:relative;overflow:hidden;background:#111128;cursor:crosshair;touch-action:none;}
#canvas-container{position:absolute;transform-origin:0 0;}
.canvas-layer{position:absolute;top:0;left:0;}
#canvas-bg{position:absolute;top:0;left:0;background:#fff;box-shadow:0 4px 24px rgba(0,0,0,0.5);}
#onion-canvas{position:absolute;top:0;left:0;pointer-events:none;opacity:0.3;}
#stroke-guide-canvas{position:absolute;top:0;left:0;pointer-events:none;z-index:5;}
#cursor-preview{position:fixed;pointer-events:none;border:1.5px solid rgba(233,69,96,0.7);border-radius:50%;z-index:100;display:none;}
#rotation-indicator{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:var(--text-primary);padding:4px 12px;border-radius:4px;font-size:12px;display:none;z-index:50;}
#zoom-indicator{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:var(--text-primary);padding:4px 12px;border-radius:4px;font-size:11px;z-index:50;}
#stroke-order-overlay{position:absolute;top:0;left:0;pointer-events:none;z-index:10;}
#point-edit-overlay{position:absolute;top:0;left:0;pointer-events:none;z-index:6;}
#view-tools{display:flex;align-items:center;gap:3px;}
.view-tool-btn{font-size:16px !important;}
.view-tool-btn.active{background:var(--accent) !important;color:#fff !important;}
#frame-guide-overlay{position:absolute;pointer-events:none;z-index:8;border:2px solid rgba(0,180,255,0.7);box-sizing:border-box;display:none;box-shadow:0 0 0 9999px rgba(0,0,0,0.25);}

#right-panel{width:220px;background:var(--bg-panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;}
.panel-section{border-bottom:1px solid var(--border);}
.panel-header{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--bg-secondary);font-size:11px;font-weight:600;color:var(--text-secondary);}
.panel-body{padding:8px;}
.layer-item{display:flex;align-items:center;gap:6px;padding:5px 6px;border-radius:4px;cursor:pointer;font-size:11px;margin-bottom:2px;}
.layer-item:hover{background:var(--bg-input);}
.layer-item.active{background:var(--bg-tertiary);outline:1px solid var(--accent);}
.layer-color-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.layer-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.layer-vis-btn{width:20px;height:20px;background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;border-radius:3px;}
.layer-vis-btn:hover{background:var(--bg-input);color:var(--text-primary);}
.layer-vis-btn.hidden{opacity:0.3;}
.layer-actions{display:flex;gap:4px;padding:4px 6px;}
.layer-action-btn{flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text-secondary);padding:3px;font-size:10px;border-radius:3px;cursor:pointer;}
.layer-action-btn:hover{background:var(--bg-tertiary);color:var(--text-primary);}
.onion-row{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-secondary);margin-bottom:4px;}
.onion-row label{flex:1;}
.onion-row input[type="checkbox"]{accent-color:var(--accent);}
.onion-row input[type="number"]{width:50px;background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);padding:2px 4px;font-size:10px;border-radius:3px;text-align:center;}

.cut-item{display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:11px;margin-bottom:2px;}
.cut-item:hover{background:var(--bg-input);}
.cut-item.active{background:var(--bg-tertiary);outline:1px solid var(--accent);}
.cut-item .cut-label{flex:1;font-weight:600;}
.cut-item .cut-frames{font-size:9px;color:var(--text-muted);}
.cut-actions{display:flex;gap:4px;padding:4px 6px;}

#timeline-panel{position:fixed;bottom:0;left:44px;right:220px;background:var(--bg-panel);border-top:1px solid var(--border);display:flex;flex-direction:column;z-index:20;}
#timeline-controls{display:flex;align-items:center;gap:4px;padding:4px 8px;background:var(--bg-secondary);border-bottom:1px solid var(--border);min-height:32px;flex-shrink:0;flex-wrap:wrap;}
.tl-btn{width:26px;height:26px;background:var(--bg-input);border:1px solid var(--border);color:var(--text-secondary);border-radius:3px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;}
.tl-btn:hover{background:var(--bg-tertiary);color:var(--text-primary);}
.tl-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.tl-info{font-size:11px;color:var(--text-secondary);margin-left:6px;}
.tl-info span{color:var(--text-primary);font-weight:600;}
#fps-input{width:36px;background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);padding:2px 4px;font-size:11px;border-radius:3px;text-align:center;}
#timeline-body{flex:1;display:flex;overflow:hidden;}
#tl-layer-labels{width:100px;background:var(--bg-secondary);border-right:1px solid var(--border);overflow:hidden;flex-shrink:0;}
#tl-layer-labels-inner{padding-top:18px;}
.tl-layer-label{height:24px;display:flex;align-items:center;padding:0 8px;font-size:10px;color:var(--text-secondary);border-bottom:1px solid var(--border);cursor:pointer;}
.tl-layer-label.active{color:var(--text-primary);background:var(--bg-tertiary);}
.tl-layer-label .dot{width:6px;height:6px;border-radius:50%;margin-right:6px;flex-shrink:0;}
#tl-frames-area{flex:1;overflow-x:auto;overflow-y:auto;position:relative;}
#tl-header{position:sticky;top:0;height:18px;background:var(--bg-secondary);border-bottom:1px solid var(--border);z-index:2;display:flex;}
.tl-frame-num{width:28px;min-width:28px;height:18px;display:flex;align-items:center;justify-content:center;font-size:8px;color:var(--text-muted);border-right:1px solid var(--border);cursor:pointer;}
.tl-frame-num.current{background:var(--accent);color:#fff;}
#tl-rows{position:relative;}
.tl-row{height:24px;display:flex;border-bottom:1px solid var(--border);}
.tl-cell{width:28px;min-width:28px;height:24px;border-right:1px solid rgba(42,42,74,0.5);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;}
.tl-cell:hover{background:rgba(233,69,96,0.1);}
.tl-cell.has-data{background:rgba(78,205,196,0.15);}
.tl-cell.has-data::after{content:'';width:8px;height:8px;background:var(--success);border-radius:50%;}
.tl-cell.current-frame{background:rgba(233,69,96,0.15);}
.tl-cell.hold-frame{background:rgba(249,168,37,0.08);}
.tl-cell.hold-frame::after{content:'';width:14px;height:3px;background:var(--warning);border-radius:2px;opacity:0.5;}
.tl-cell.hold-start{background:rgba(249,168,37,0.2);}
.tl-cell.hold-start::after{content:'';width:8px;height:8px;background:var(--warning);border-radius:50%;}
.tl-cell.tl-selected{outline:2px solid var(--accent);outline-offset:-2px;z-index:1;}
.tl-cell.tl-drag-ghost{background:rgba(233,69,96,0.25);outline:2px dashed var(--accent);outline-offset:-2px;z-index:1;}

/* ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
#ctx-menu{display:none;position:fixed;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:6px;padding:4px 0;z-index:300;box-shadow:0 4px 16px rgba(0,0,0,0.6);min-width:160px;}
.ctx-item{padding:6px 14px;font-size:11px;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:8px;}
.ctx-item:hover{background:var(--bg-tertiary);color:var(--text-primary);}
.ctx-item.disabled{opacity:0.35;pointer-events:none;}
.ctx-sep{height:1px;background:var(--border);margin:3px 8px;}
.ctx-item .ctx-shortcut{margin-left:auto;font-size:9px;color:var(--text-muted);}

.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:500;align-items:center;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-box{background:var(--bg-panel);border:1px solid var(--border-light);border-radius:8px;padding:20px;min-width:300px;box-shadow:0 8px 32px rgba(0,0,0,0.5);}
.modal-box h3{font-size:14px;margin-bottom:12px;color:var(--accent);}
.modal-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.modal-row label{font-size:12px;color:var(--text-secondary);width:70px;}
.modal-row input,.modal-row select{flex:1;background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);padding:5px 8px;font-size:12px;border-radius:4px;}
.modal-buttons{display:flex;gap:8px;margin-top:14px;justify-content:flex-end;}
.modal-btn{padding:5px 16px;font-size:12px;border-radius:4px;border:1px solid var(--border);cursor:pointer;}
.modal-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
.modal-btn.secondary{background:var(--bg-input);color:var(--text-secondary);}
.modal-btn:hover{opacity:0.85;}
#inbetween-preview{width:100%;height:150px;background:#fff;border:1px solid var(--border);border-radius:4px;margin:8px 0;}
#notification{position:fixed;top:50px;right:20px;background:var(--bg-secondary);border:1px solid var(--success);color:var(--text-primary);padding:8px 16px;border-radius:6px;font-size:12px;z-index:999;display:none;box-shadow:0 4px 16px rgba(0,0,0,0.4);}
#export-progress{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-panel);border:1px solid var(--border-light);border-radius:8px;padding:24px;z-index:600;display:none;text-align:center;min-width:260px;box-shadow:0 8px 32px rgba(0,0,0,0.6);}
#export-progress h4{font-size:13px;color:var(--accent);margin-bottom:10px;}
#export-progress-bar{width:100%;height:6px;background:var(--bg-input);border-radius:3px;overflow:hidden;margin-bottom:8px;}
#export-progress-fill{height:100%;background:var(--accent);width:0%;transition:width 0.2s;}
#export-progress-text{font-size:11px;color:var(--text-secondary);}

/* ãƒ¢ãƒã‚¤ãƒ«/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ */
@media(max-width:900px){
  #app{flex-direction:column;}
  #main-area{flex-direction:column;}
  #toolbar{flex-direction:row;width:100%;height:40px;overflow-x:auto;overflow-y:hidden;}
  #right-panel{width:100%;max-height:200px;overflow-y:auto;flex-direction:row;flex-wrap:wrap;}
  #right-panel .panel-section{min-width:180px;flex:1;}
  #timeline-panel{left:0;right:0;}
  #canvas-area{min-height:300px;}
  #header{flex-wrap:wrap;height:auto;padding:4px 8px;}
  .header-btn{padding:4px 8px;font-size:10px;}
  .tool-btn{width:34px;height:34px;min-width:34px;font-size:14px;}
}
@media(max-width:600px){
  #right-panel{max-height:160px;}
  .tl-cell{width:22px;min-width:22px;height:20px;}
  .tl-frame-num{width:22px;min-width:22px;}
}
/* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã§ãƒ›ãƒãƒ¼ç„¡åŠ¹ */
@media(hover:none){
  .tl-cell:hover{background:none;}
  .tool-btn:hover{background:none;}
  .header-btn:hover{background:none;}
}
</style>
</head>
<body>
<div id="header">
  <span class="app-title">âœ¦ Stroke Animation Studio</span>
  <input type="text" id="project-name-input" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå" value="untitled">
  <div class="header-sep"></div>
  <button class="header-btn" onclick="newProject()">æ–°è¦</button>
  <button class="header-btn" onclick="saveProject()">ğŸ’¾ ä¿å­˜</button>
  <button class="header-btn" onclick="loadProject()">ğŸ“‚ é–‹ã</button>
  <div class="header-sep"></div>
  <button class="header-btn" onclick="showCanvasSizeDialog()">ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º</button>
  <button class="header-btn" onclick="importDraftImage()">ä¸‹æ›¸ãèª­è¾¼</button>
  <div class="header-sep"></div>
  <button class="header-btn" onclick="undoAction()">â†© æˆ»ã™</button>
  <button class="header-btn" onclick="redoAction()">â†ª ã‚„ã‚Šç›´ã—</button>
  <div class="header-sep"></div>
  <button class="header-btn" onclick="exportAllPNG()">ğŸ“¦ é€£ç•ªPNGå‡ºåŠ›</button>
</div>

<div id="main-layout">
  <div id="toolbar">
    <button class="tool-btn active" data-tool="pen" title="ãƒšãƒ³ (P)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg><span class="shortcut">P</span></button>
    <button class="tool-btn" data-tool="line" title="ç›´ç·š (L)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="19" x2="19" y2="5"/></svg><span class="shortcut">L</span></button>
    <button class="tool-btn" data-tool="circle" title="å††å½¢ (C)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg><span class="shortcut">C</span></button>
    <button class="tool-btn" data-tool="rect" title="å››è§’å½¢ (R)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="1"/></svg><span class="shortcut">R</span></button>
    <div class="tool-sep"></div>
    <button class="tool-btn" data-tool="eraser" title="æ¶ˆã—ã‚´ãƒ  (E)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16l8-8 9 9-4 3z"/><path d="M6.5 13.5l5-5"/></svg><span class="shortcut">E</span></button>
    <div class="tool-sep"></div>
    <button class="tool-btn" data-tool="point" title="ãƒã‚¤ãƒ³ãƒˆç·¨é›† (A)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg><span class="shortcut">A</span></button>
    <button class="tool-btn" data-tool="stroke" title="ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç·¨é›† (S)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" stroke-dasharray="4 2"/><path d="M7 12h10M12 7v10"/></svg><span class="shortcut">S</span></button>
    <button class="tool-btn" data-tool="move" title="å…¨ä½“ç§»å‹• (V)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 9l-3 3 3 3"/><path d="M9 5l3-3 3 3"/><path d="M15 19l-3 3-3-3"/><path d="M19 9l3 3-3 3"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg><span class="shortcut">V</span></button>
    <div class="tool-sep"></div>
    <div id="pen-settings">
      <label>ã‚µã‚¤ã‚º</label><span id="pen-size-val">2</span>
      <input type="range" id="pen-size" min="1" max="30" value="2">
      <label>è£œæ­£</label><span id="pen-smooth-val">50</span>
      <input type="range" id="pen-smooth" min="0" max="100" value="50">
      <label>è‰²</label><input type="color" id="pen-color" value="#000000">
    </div>
    <div id="stroke-point-settings" style="display:none;">
      <label>ãƒã‚¤ãƒ³ãƒˆæ•°</label><span id="stroke-point-val">-</span>
      <input type="range" id="stroke-point-slider" min="2" max="100" value="10">
    </div>
  </div>

  <div id="canvas-area">
    <div id="canvas-container">
      <div id="canvas-bg"></div>
      <canvas id="onion-canvas" class="canvas-layer"></canvas>
      <canvas id="stroke-guide-canvas" class="canvas-layer"></canvas>
      <canvas id="point-edit-overlay" class="canvas-layer"></canvas>
      <div id="frame-guide-overlay"></div>
    </div>
    <canvas id="stroke-order-overlay"></canvas>
    <div id="rotation-indicator"></div>
    <div id="zoom-indicator">100%</div>
    <div id="cursor-preview"></div>
  </div>

  <div id="right-panel">
    <div class="panel-section">
      <div class="panel-header">ã‚«ãƒƒãƒˆç®¡ç†</div>
      <div class="panel-body" id="cut-list" style="max-height:108px;overflow-y:auto;"></div>
      <div class="cut-actions"><button class="layer-action-btn" onclick="addCut()">è¿½åŠ </button><button class="layer-action-btn" onclick="removeCut()">å‰Šé™¤</button></div>
    </div>
    <div class="panel-section">
      <div class="panel-header">ãƒ¬ã‚¤ãƒ¤ãƒ¼</div>
      <div class="panel-body" id="layer-list"></div>
      <div class="layer-actions"><button class="layer-action-btn" onclick="clearCurrentLayer()">ã‚¯ãƒªã‚¢</button><button class="layer-action-btn" onclick="duplicateFrame()">è¤‡è£½</button></div>
      <div class="onion-row" style="margin-top:4px;"><label>ä¸‹æ›¸ãä¸é€æ˜åº¦</label><input type="range" id="draft-opacity" min="0" max="100" value="40" style="width:60px;" oninput="draftOpacity=this.value/100;document.getElementById('draft-opacity-val').textContent=this.value+'%';renderAll();"><span id="draft-opacity-val" style="font-size:10px;color:var(--text-secondary);margin-left:4px;">40%</span></div>
    </div>
    <div class="panel-section">
      <div class="panel-header">ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³</div>
      <div class="panel-body">
        <div class="onion-row"><label>æœ‰åŠ¹</label><input type="checkbox" id="onion-enabled" checked onchange="renderAll()"></div>
        <div class="onion-row"><label>å‰ãƒ•ãƒ¬ãƒ¼ãƒ æ•°</label><input type="number" id="onion-prev" value="1" min="0" max="5" onchange="renderAll()"></div>
        <div class="onion-row"><label>æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ æ•°</label><input type="number" id="onion-next" value="1" min="0" max="5" onchange="renderAll()"></div>
        <div class="onion-row"><label>æ›¸ãé †ã‚¬ã‚¤ãƒ‰</label><input type="checkbox" id="stroke-guide-enabled" onchange="renderAll()"></div>
      </div>
    </div>
    <div class="panel-section">
      <div class="panel-header">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±</div>
      <div class="panel-body">
        <div class="onion-row"><label>å¹…</label><input type="number" id="info-width" value="2600" min="1" max="8192" onchange="applyProjectInfo()"></div>
        <div class="onion-row"><label>é«˜ã•</label><input type="number" id="info-height" value="1500" min="1" max="8192" onchange="applyProjectInfo()"></div>
        <div class="onion-row"><label>ãƒ•ãƒ¬ãƒ¼ãƒ æ•°</label><input type="number" id="info-frames" value="24" min="1" max="9999" onchange="applyProjectInfoFrames()"></div>
      </div>
    </div>
    <div class="panel-section">
      <div class="panel-header">æ ã‚¬ã‚¤ãƒ‰</div>
      <div class="panel-body">
        <div class="onion-row"><label>è¡¨ç¤º</label><input type="checkbox" id="frame-guide-enabled" checked onchange="updateFrameGuide()"></div>
        <div class="onion-row"><label>å¹…</label><input type="number" id="frame-guide-w" value="1920" min="1" max="8192" onchange="updateFrameGuide()"></div>
        <div class="onion-row"><label>é«˜ã•</label><input type="number" id="frame-guide-h" value="1080" min="1" max="8192" onchange="updateFrameGuide()"></div>
      </div>
    </div>
    <div class="panel-section">
      <div class="panel-header">æ“ä½œãƒ˜ãƒ«ãƒ—</div>
      <div class="panel-body" style="font-size:10px;color:var(--text-muted);line-height:1.6;">
        Ctrl+Space+ãƒ‰ãƒ©ãƒƒã‚°: å›è»¢<br>ãƒ›ã‚¤ãƒ¼ãƒ«: æ‹¡å¤§ç¸®å°<br>Space+ãƒ‰ãƒ©ãƒƒã‚°: ãƒ‘ãƒ³<br>
        Ctrl+Z/Y: å…ƒã«æˆ»ã™/ã‚„ã‚Šç›´ã—<br>Ctrl+S: ä¿å­˜<br>â†’/â†: ãƒ•ãƒ¬ãƒ¼ãƒ ç§»å‹•<br>
        å³ã‚¯ãƒªãƒƒã‚¯: ã‚³ãƒ”ãƒ¼/ãƒšãƒ¼ã‚¹ãƒˆ/æŒç¶šè¨­å®š<br>Esc: å›è»¢ãƒªã‚»ãƒƒãƒˆ/é¸æŠè§£é™¤<br>
        A: ãƒã‚¤ãƒ³ãƒˆç·¨é›†ï¼ˆé€šéç‚¹ã®ç§»å‹•ï¼‰<br>S: ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç·¨é›†ï¼ˆé¸æŠã—ã¦ç§»å‹•/æ‹¡ç¸®/å›è»¢ï¼‰<br>V: å…¨ä½“ç§»å‹•<br>
        ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³: ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ç§»å‹•<br>Shift+ã‚¯ãƒªãƒƒã‚¯: è¤‡æ•°é¸æŠ<br>Del: é¸æŠã‚¯ãƒªã‚¢
      </div>
    </div>
  </div>
</div>

<div id="timeline-panel">
  <div id="timeline-controls">
    <button class="tl-btn" onclick="goFirstFrame()" title="æœ€åˆ">â®</button>
    <button class="tl-btn" onclick="goPrevFrame()" title="å‰">â—€</button>
    <button class="tl-btn" id="play-btn" onclick="togglePlay()" title="å†ç”Ÿ/åœæ­¢">â–¶</button>
    <button class="tl-btn" onclick="goNextFrame()" title="æ¬¡">â–¶</button>
    <button class="tl-btn" onclick="goLastFrame()" title="æœ€å¾Œ">â­</button>
    <div class="header-sep"></div>
    <button class="tl-btn" onclick="addFrame()" title="ãƒ•ãƒ¬ãƒ¼ãƒ è¿½åŠ ">ï¼‹</button>
    <button class="tl-btn" onclick="removeFrame()" title="ãƒ•ãƒ¬ãƒ¼ãƒ å‰Šé™¤">ï¼</button>
    <button class="tl-btn" onclick="insertKeyframe()" title="ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ æŒ¿å…¥">â—†</button>
    <div class="header-sep"></div>
    <span class="tl-info">ãƒ•ãƒ¬ãƒ¼ãƒ : <span id="current-frame-display">1</span>/<span id="total-frame-display">24</span></span>
    <div class="header-sep"></div>
    <span class="tl-info">FPS:</span><input type="number" id="fps-input" value="12" min="1" max="60" onchange="updateFPS()">
    <div class="header-sep"></div>
    <span class="tl-info">ã‚«ãƒƒãƒˆ: <span id="current-cut-display">C_001</span></span>
    <div class="header-sep"></div>
    <button class="header-btn" onclick="toggleOnionSkin()" title="ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³" style="font-size:10px;">ğŸ§…ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³</button>
    <button class="header-btn" onclick="showInbetweenDialog()">ğŸ¬ è‡ªå‹•ä¸­å‰²</button>
    <button class="header-btn" onclick="toggleStrokeGuide()">âœï¸ æ›¸ãé †ã‚¬ã‚¤ãƒ‰</button>
    <div class="header-sep"></div>
    <div id="view-tools">
      <button class="header-btn view-tool-btn" id="vt-pan" onclick="setViewTool('pan')">âœ‹ç”»é¢ç§»å‹•</button>
      <button class="header-btn view-tool-btn" id="vt-rotate" onclick="setViewTool('rotate')">ğŸ”ã‚­ãƒ£ãƒ³ãƒã‚¹å›è»¢</button>
      <button class="header-btn view-tool-btn" id="vt-reset-rot" onclick="S.rot=0;updateTransform();">ğŸ”‚å›è»¢ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="header-btn view-tool-btn" id="vt-fit" onclick="centerCanvas()">ğŸªŸãƒ•ã‚£ãƒƒãƒˆ</button>
      <span style="font-size:11px;">ğŸ”</span>
      <input type="range" id="zoom-slider" min="10" max="500" value="100" title="ã‚ºãƒ¼ãƒ " style="width:120px;" oninput="applyZoomSlider(this.value)">
      <span id="zoom-slider-val" style="font-size:10px;color:var(--text-secondary);min-width:28px;">100%</span>
    </div>
  </div>
  <div id="timeline-body">
    <div id="tl-layer-labels"><div id="tl-layer-labels-inner"></div></div>
    <div id="tl-frames-area"><div id="tl-header"></div><div id="tl-rows"></div></div>
  </div>
</div>

<!-- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="ctx-menu">
  <div class="ctx-item" onclick="ctxCopyFrame()">ğŸ“‹ ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚³ãƒ”ãƒ¼<span class="ctx-shortcut">Ctrl+C</span></div>
  <div class="ctx-item" id="ctx-paste" onclick="ctxPasteFrame()">ğŸ“Œ ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è²¼ã‚Šä»˜ã‘<span class="ctx-shortcut">Ctrl+V</span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxCopyAllLayers()">ğŸ“‹ å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ”ãƒ¼</div>
  <div class="ctx-item" id="ctx-paste-all" onclick="ctxPasteAllLayers()">ğŸ“Œ å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼è²¼ã‚Šä»˜ã‘</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxClearFrame()">ğŸ—‘ï¸ ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢</div>
  <div class="ctx-item" onclick="ctxInsertFrame()">â—† ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ æŒ¿å…¥</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxSetDuration()">â±ï¸ æŒç¶šãƒ•ãƒ¬ãƒ¼ãƒ è¨­å®š...</div>
</div>

<div class="modal-overlay" id="canvas-size-modal">
  <div class="modal-box"><h3>ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º</h3>
    <div class="modal-row"><label>å¹…:</label><input type="number" id="canvas-w-input" value="2600" min="1" max="8192"></div>
    <div class="modal-row"><label>é«˜ã•:</label><input type="number" id="canvas-h-input" value="1500" min="1" max="8192"></div>
    <div class="modal-buttons"><button class="modal-btn secondary" onclick="closeModal('canvas-size-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="modal-btn primary" onclick="applyCanvasSize()">é©ç”¨</button></div>
  </div>
</div>
<div class="modal-overlay" id="inbetween-dialog">
  <div class="modal-box" style="min-width:360px;"><h3>ğŸ¬ è‡ªå‹•ä¸­å‰²ç”Ÿæˆ</h3>
    <div class="modal-row"><label>é–‹å§‹ãƒ•ãƒ¬ãƒ¼ãƒ :</label><input type="number" id="inb-start" value="1" min="1"></div>
    <div class="modal-row"><label>çµ‚äº†ãƒ•ãƒ¬ãƒ¼ãƒ :</label><input type="number" id="inb-end" value="2" min="1"></div>
    <div class="modal-row"><label>æŒ¿å…¥æšæ•°:</label><input type="number" id="inb-count" value="3" min="1" max="30"></div>
    <div class="modal-row"><label>ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°:</label><select id="inb-easing"><option value="linear">ãƒªãƒ‹ã‚¢</option><option value="easeIn">ã‚¤ãƒ¼ã‚ºã‚¤ãƒ³</option><option value="easeOut">ã‚¤ãƒ¼ã‚ºã‚¢ã‚¦ãƒˆ</option><option value="easeInOut">ã‚¤ãƒ¼ã‚ºã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</option></select></div>
    <canvas id="inbetween-preview"></canvas>
    <div class="modal-buttons"><button class="modal-btn secondary" onclick="closeModal('inbetween-dialog')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="modal-btn primary" onclick="generateInbetweens()">ç”Ÿæˆ</button></div>
  </div>
</div>
<div class="modal-overlay" id="duration-modal">
  <div class="modal-box" style="min-width:240px;"><h3>â±ï¸ æŒç¶šãƒ•ãƒ¬ãƒ¼ãƒ è¨­å®š</h3>
    <div class="modal-row"><label>ãƒ•ãƒ¬ãƒ¼ãƒ æ•°:</label><input type="number" id="dur-modal-input" value="1" min="1" max="100"></div>
    <div class="modal-buttons"><button class="modal-btn secondary" onclick="closeModal('duration-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="modal-btn primary" onclick="applyDurModal()">é©ç”¨</button></div>
  </div>
</div>

<div id="export-progress"><h4>ğŸ“¦ é€£ç•ªPNGæ›¸ãå‡ºã—ä¸­...</h4><div id="export-progress-bar"><div id="export-progress-fill"></div></div><div id="export-progress-text">0 / 0</div></div>
<div id="notification"></div>
<input type="file" id="file-input-project" accept=".json,.sasp" style="display:none" onchange="handleLoadProject(event)">
<input type="file" id="file-input-draft" accept="image/*" style="display:none" onchange="handleDraftImage(event)">

<script>
const LAYER_DEFS=[
  {id:'draw1',name:'ç·šç”»1',color:'var(--layer-color-1)',type:'draw'},
  {id:'draw2',name:'ç·šç”»2',color:'var(--layer-color-2)',type:'draw'},
  {id:'draw3',name:'ç·šç”»3',color:'var(--layer-color-3)',type:'draw'},
  {id:'draw4',name:'ç·šç”»4',color:'var(--layer-color-4)',type:'draw'},
  {id:'draft1',name:'ä¸‹æ›¸ã1',color:'var(--draft-color-1)',type:'draft'},
  {id:'draft2',name:'ä¸‹æ›¸ã2',color:'var(--draft-color-2)',type:'draft'},
  {id:'draft3',name:'ä¸‹æ›¸ã3',color:'var(--draft-color-3)',type:'draft'},
  {id:'draft4',name:'ä¸‹æ›¸ã4',color:'var(--draft-color-4)',type:'draft'},
];

let cuts=[];let currentCut=0;
let S={cw:2600,ch:1500,fps:12,frame:0,layer:0,tool:'pen',penSize:2,penColor:'#000000',penSmooth:50,zoom:1,rot:0,panX:0,panY:0,playing:false,playTimer:null};
let layerVis={};let undoStack=[],redoStack=[];const MAX_UNDO=50;
let layerCanvases=[],layerCtxs=[];
let onionCanvas,onionCtx,guideCanvas,guideCtx,overlayCanvas,overlayCtx;
let drawing=false,panning=false,rotating=false;
let curPoints=[],shapeStart=null,lastMouse={x:0,y:0};
let drawingSnapshot=null; // æç”»é–‹å§‹æ™‚ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼canvasã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
let spaceHeld=false,ctrlHeld=false;
let draftImgCache={};let strokeGuideVisible=false;
let draftOpacity=0.4; // ä¸‹æ›¸ããƒ¬ã‚¤ãƒ¤ãƒ¼ä¸é€æ˜åº¦
let frameGuideW=1920,frameGuideH=1080; // æ ã‚¬ã‚¤ãƒ‰ã‚µã‚¤ã‚º
let viewTool=''; // '' | 'pan' | 'rotate' ï¼ˆç©º=é€šå¸¸æç”»ãƒ¢ãƒ¼ãƒ‰ï¼‰

// ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ã‚³ãƒ”ãƒ¼ç”¨ï¼‰
let clipFrame=null;       // å˜ä¸€ãƒ¬ã‚¤ãƒ¤ãƒ¼ {strokes, draftImg}
let clipAllFrames=null;   // å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ [{strokes, draftImg}, ...]
// ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼å¯¾è±¡
let ctxLayer=-1,ctxFrame=-1;

// ãƒã‚¤ãƒ³ãƒˆç·¨é›†ãƒ„ãƒ¼ãƒ«ç”¨
let pointEditCanvas,pointEditCtx;
let selectedStrokeIdx=-1;   // é¸æŠä¸­ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯index
let dragPointInfo=null;     // {strokeIdx, type, idx, sub} ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®åˆ¶å¾¡ç‚¹æƒ…å ±
let selectedPointInfo=null; // é¸æŠä¸­ã®ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ï¼ˆãƒãƒ³ãƒ‰ãƒ«è¡¨ç¤ºç”¨ã€mouseupå¾Œã‚‚ä¿æŒï¼‰
let POINT_RADIUS=5;         // åˆ¶å¾¡ç‚¹ã®è¡¨ç¤ºåŠå¾„ï¼ˆcanvasåº§æ¨™ï¼‰

// ç§»å‹•ãƒ„ãƒ¼ãƒ«ç”¨
let moveMode='all';         // 'all' | 'single'
let moveDragging=false;
let moveDragStart=null;     // {x, y}
let moveTargetIdx=-1;       // singleæ™‚ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯index

// ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç·¨é›†ãƒ„ãƒ¼ãƒ«ç”¨
let strokeEditIdx=-1;       // é¸æŠä¸­ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯index
let strokeEditMode='';      // '' | 'move' | 'scale' | 'rotate'
let strokeEditStart=null;   // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹åº§æ¨™
let strokeEditAnchor=null;  // å›è»¢ã‚¢ãƒ³ã‚«ãƒ¼ {x,y} ã‚¯ãƒªãƒƒã‚¯ä½ç½®
let strokeEditInitAngle=0;  // åˆæœŸè§’åº¦ï¼ˆå›è»¢ç”¨ï¼‰
let strokeEditInitScale=1;  // åˆæœŸè·é›¢ï¼ˆæ‹¡ç¸®ç”¨ï¼‰
// ãƒœãƒƒã‚¯ã‚¹çŠ¶æ…‹: 4é ‚ç‚¹ã§ç®¡ç†ï¼ˆå›è»¢å¯¾å¿œï¼‰
let strokeEditCorners=null; // [tl,tr,br,bl] å„{x,y}
let strokeEditCenter=null;  // {x,y} ãƒœãƒƒã‚¯ã‚¹ä¸­å¿ƒ

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‰ãƒ©ãƒƒã‚°ç”¨
let tlSelected=new Set();   // é¸æŠä¸­ã‚»ãƒ« Set of 'li-fi' strings
let tlDragging=false;
let tlDragSource=null;      // {li,fi} ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã‚»ãƒ«
let tlDragCurrent=null;     // ç¾åœ¨ãƒã‚¦ã‚¹ä¸‹ã®ãƒ•ãƒ¬ãƒ¼ãƒ index
let tlDragOffset=0;         // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ä½ç½®ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ

function CC(){return cuts[currentCut];}
function CF(){return CC().layers;}
function CTF(){return CC().totalFrames;}
function CFD(){return CC().frameDur;}

// æŒç¶šãƒ•ãƒ¬ãƒ¼ãƒ å¯¾å¿œï¼šfiä½ç½®ã§å®Ÿéš›ã«è¡¨ç¤ºã™ã¹ããƒ•ãƒ¬ãƒ¼ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿”ã™
// frameDur[li+'-'+f]ãŒd(>=2)ãªã‚‰ fï½f+d-1 ã®ç¯„å›²ã¯fã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
function getEffectiveFrameIdx(li,fi){
  const dur=CFD();
  for(let f=fi;f>=0;f--){
    const d=dur[li+'-'+f]||1;
    if(d>1&&fi>=f&&fi<=f+d-1)return f;
  }
  return fi;
}
function getEffectiveFrame(li,fi){
  const eidx=getEffectiveFrameIdx(li,fi);
  const frames=CF()[li].frames;
  if(eidx<0||eidx>=frames.length)return null;
  return frames[eidx];
}

// ===========================================================
// åˆæœŸåŒ–
// ===========================================================
function init(){
  cuts.push(createEmptyCut('C_001',24));
  for(let i=0;i<LAYER_DEFS.length;i++)layerVis[i]=true;
  createCanvases();updateCutList();updateLayerList();updateTimeline();updateTransform();
  renderAll();setupEvents();centerCanvas();
}
function createEmptyCut(name,frames){
  const c={name,totalFrames:frames,frameDur:{},layers:[]};
  for(let i=0;i<LAYER_DEFS.length;i++){c.layers.push({frames:[]});for(let f=0;f<frames;f++)c.layers[i].frames.push({strokes:[],draftImg:null});}
  return c;
}
function createCanvases(){
  const ct=document.getElementById('canvas-container');layerCanvases.forEach(c=>c.remove());layerCanvases=[];layerCtxs=[];
  const bg=document.getElementById('canvas-bg');bg.style.width=S.cw+'px';bg.style.height=S.ch+'px';
  onionCanvas=document.getElementById('onion-canvas');onionCanvas.width=S.cw;onionCanvas.height=S.ch;onionCtx=onionCanvas.getContext('2d');
  guideCanvas=document.getElementById('stroke-guide-canvas');guideCanvas.width=S.cw;guideCanvas.height=S.ch;guideCtx=guideCanvas.getContext('2d');
  pointEditCanvas=document.getElementById('point-edit-overlay');pointEditCanvas.width=S.cw;pointEditCanvas.height=S.ch;pointEditCtx=pointEditCanvas.getContext('2d');
  overlayCanvas=document.getElementById('stroke-order-overlay');overlayCanvas.width=S.cw;overlayCanvas.height=S.ch;overlayCtx=overlayCanvas.getContext('2d');
  for(let i=0;i<LAYER_DEFS.length;i++){const c=document.createElement('canvas');c.className='canvas-layer';c.width=S.cw;c.height=S.ch;c.style.width=S.cw+'px';c.style.height=S.ch+'px';ct.appendChild(c);layerCanvases.push(c);const ctx=c.getContext('2d');ctx.imageSmoothingEnabled=false;layerCtxs.push(ctx);}
}
function centerCanvas(){
  const a=document.getElementById('canvas-area').getBoundingClientRect();
  const tlPanel=document.getElementById('timeline-panel');
  const tlH=tlPanel?tlPanel.offsetHeight:0;
  const viewH=a.height-tlH;
  const viewW=a.width;
  // ç¸¦å¹…ã«ãƒ•ã‚£ãƒƒãƒˆï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®æ‰‹å‰ã¾ã§ï¼‰
  const fitZoom=viewH/S.ch;
  S.zoom=fitZoom;
  S.rot=0;
  S.panX=(viewW-S.cw*S.zoom)/2;
  S.panY=0;
  updateTransform();
}
function updateTransform(){
  // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¿ƒã‚’è»¸ã«å›è»¢: translate(pan) â†’ translate(center) â†’ rotate â†’ translate(-center) â†’ scale
  const cx=S.cw*S.zoom/2, cy=S.ch*S.zoom/2;
  document.getElementById('canvas-container').style.transform=
    `translate(${S.panX}px,${S.panY}px) translate(${cx}px,${cy}px) rotate(${S.rot}deg) translate(${-cx}px,${-cy}px) scale(${S.zoom})`;
  document.getElementById('zoom-indicator').textContent=Math.round(S.zoom*100)+'%';
  const zs=document.getElementById('zoom-slider');
  if(zs)zs.value=Math.round(S.zoom*100);
  const zv=document.getElementById('zoom-slider-val');
  if(zv)zv.textContent=Math.round(S.zoom*100)+'%';
}

function setViewTool(t){
  viewTool=(viewTool===t)?'':t;
  document.querySelectorAll('.view-tool-btn').forEach(b=>b.classList.remove('active'));
  if(viewTool==='pan')document.getElementById('vt-pan').classList.add('active');
  if(viewTool==='rotate')document.getElementById('vt-rotate').classList.add('active');
}
function applyZoomSlider(v){
  const newZoom=Math.max(0.1,Math.min(10,v/100));
  const a=document.getElementById('canvas-area').getBoundingClientRect();
  const cx=a.width/2,cy=a.height/2;
  const oldZoom=S.zoom;
  S.panX=cx-(cx-S.panX)*(newZoom/oldZoom);
  S.panY=cy-(cy-S.panY)*(newZoom/oldZoom);
  S.zoom=newZoom;
  updateTransform();
}

// ===========================================================
// ã‚¤ãƒ™ãƒ³ãƒˆ
// ===========================================================
function setupEvents(){
  const area=document.getElementById('canvas-area');
  area.addEventListener('mousedown',onDown);area.addEventListener('mousemove',onMove);area.addEventListener('mouseup',onUp);area.addEventListener('mouseleave',onUp);
  area.addEventListener('wheel',onWheel,{passive:false});area.addEventListener('contextmenu',e=>e.preventDefault());

  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼šã‚¹ã‚¿ã‚¤ãƒ©ã‚¹(pen)ã®ã¿æç”»ã€æŒ‡(touch)ã¯ãƒ“ãƒ¥ãƒ¼æ“ä½œ
  let stylusId=null;
  let fingerTouches=[];  // æŒ‡ã‚¿ãƒƒãƒç®¡ç†
  let lastFingerPos=null; // 1æœ¬æŒ‡ãƒ‘ãƒ³ç”¨
  let lastPinchDist=0,lastPinchAngle=0,lastPinchCenter=null;

  area.addEventListener('touchstart',e=>{
    e.preventDefault();
    for(const t of e.changedTouches){
      if(t.touchType==='stylus'||e.touches.length===1&&(t.radiusX<5&&t.radiusY<5)){
        // ã‚¹ã‚¿ã‚¤ãƒ©ã‚¹åˆ¤å®šï¼ˆtouchTypeå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ or å°ã•ã„æ¥è§¦é¢ç©ï¼‰
        // PointerEventsã§è£œå®Œã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ç°¡æ˜“åˆ¤å®š
      }
    }
    // PointerEventsã«å§”è­²ï¼ˆä¸‹ã®pointerã‚¤ãƒ™ãƒ³ãƒˆã§å‡¦ç†ï¼‰
  },{passive:false});

  // PointerEventsï¼špen/mouse â†’ æç”»ã€touch â†’ ãƒ“ãƒ¥ãƒ¼æ“ä½œ
  let pointerId=null;
  area.addEventListener('pointerdown',e=>{
    if(e.pointerType==='touch'){
      // æŒ‡ã‚¿ãƒƒãƒ â†’ ãƒ“ãƒ¥ãƒ¼æ“ä½œ
      fingerTouches.push({id:e.pointerId,x:e.clientX,y:e.clientY});
      if(fingerTouches.length===1){
        lastFingerPos={x:e.clientX,y:e.clientY};
      }else if(fingerTouches.length===2){
        // ãƒ”ãƒ³ãƒ/å›è»¢é–‹å§‹
        const dx=fingerTouches[0].x-fingerTouches[1].x,dy=fingerTouches[0].y-fingerTouches[1].y;
        lastPinchDist=Math.sqrt(dx*dx+dy*dy);
        lastPinchAngle=Math.atan2(dy,dx);
        lastPinchCenter={x:(fingerTouches[0].x+fingerTouches[1].x)/2,y:(fingerTouches[0].y+fingerTouches[1].y)/2};
      }
      return;
    }
    // ãƒšãƒ³/ãƒã‚¦ã‚¹ â†’ ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«ç¢ºèª
    if(viewTool==='pan'){
      panning=true;lastMouse={x:e.clientX,y:e.clientY};
      pointerId=e.pointerId;return;
    }
    if(viewTool==='rotate'){
      rotating=true;lastMouse={x:e.clientX,y:e.clientY};
      document.getElementById('rotation-indicator').style.display='block';
      pointerId=e.pointerId;return;
    }
    // é€šå¸¸æç”»
    pointerId=e.pointerId;
    onDown({clientX:e.clientX,clientY:e.clientY,button:e.button,preventDefault(){}});
  });
  area.addEventListener('pointermove',e=>{
    if(e.pointerType==='touch'){
      // æŒ‡ã®ä½ç½®æ›´æ–°
      for(let i=0;i<fingerTouches.length;i++){
        if(fingerTouches[i].id===e.pointerId){
          fingerTouches[i].x=e.clientX;fingerTouches[i].y=e.clientY;break;
        }
      }
      if(fingerTouches.length===1&&lastFingerPos){
        // 1æœ¬æŒ‡ãƒ‘ãƒ³
        S.panX+=e.clientX-lastFingerPos.x;S.panY+=e.clientY-lastFingerPos.y;
        lastFingerPos={x:e.clientX,y:e.clientY};
        updateTransform();
      }else if(fingerTouches.length===2){
        // 2æœ¬æŒ‡ãƒ”ãƒ³ãƒï¼‹å›è»¢
        const dx=fingerTouches[0].x-fingerTouches[1].x,dy=fingerTouches[0].y-fingerTouches[1].y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        const angle=Math.atan2(dy,dx);
        const center={x:(fingerTouches[0].x+fingerTouches[1].x)/2,y:(fingerTouches[0].y+fingerTouches[1].y)/2};
        if(lastPinchDist>0){
          // ã‚ºãƒ¼ãƒ ï¼ˆãƒ”ãƒ³ãƒä¸­å¿ƒåŸºæº–ï¼‰
          const a=document.getElementById('canvas-area').getBoundingClientRect();
          const mx=center.x-a.left,my=center.y-a.top;
          const oldZoom=S.zoom;
          S.zoom=Math.max(0.1,Math.min(10,S.zoom*(dist/lastPinchDist)));
          S.panX=mx-(mx-S.panX)*(S.zoom/oldZoom);
          S.panY=my-(my-S.panY)*(S.zoom/oldZoom);
          // å›è»¢
          const da=(angle-lastPinchAngle)*180/Math.PI;
          S.rot+=da;
          // ãƒ‘ãƒ³
          if(lastPinchCenter){
            S.panX+=center.x-lastPinchCenter.x;
            S.panY+=center.y-lastPinchCenter.y;
          }
          updateTransform();
        }
        lastPinchDist=dist;lastPinchAngle=angle;lastPinchCenter=center;
      }
      return;
    }
    if(e.pointerId!==pointerId)return;
    if(panning){S.panX+=e.clientX-lastMouse.x;S.panY+=e.clientY-lastMouse.y;lastMouse={x:e.clientX,y:e.clientY};updateTransform();return;}
    if(rotating){S.rot+=(e.clientX-lastMouse.x)*0.5;lastMouse={x:e.clientX,y:e.clientY};document.getElementById('rotation-indicator').textContent=Math.round(S.rot)+'Â°';updateTransform();return;}
    onMove({clientX:e.clientX,clientY:e.clientY,preventDefault(){}});
  });
  const pointerUp=e=>{
    if(e.pointerType==='touch'){
      fingerTouches=fingerTouches.filter(f=>f.id!==e.pointerId);
      if(fingerTouches.length<2){lastPinchDist=0;lastPinchAngle=0;lastPinchCenter=null;}
      if(fingerTouches.length===0)lastFingerPos=null;
      else if(fingerTouches.length===1)lastFingerPos={x:fingerTouches[0].x,y:fingerTouches[0].y};
      return;
    }
    if(e.pointerId!==pointerId)return;
    if(panning){panning=false;pointerId=null;return;}
    if(rotating){rotating=false;document.getElementById('rotation-indicator').style.display='none';pointerId=null;return;}
    pointerId=null;
    onUp({clientX:e.clientX,clientY:e.clientY,preventDefault(){}});
  };
  area.addEventListener('pointerup',pointerUp);area.addEventListener('pointercancel',pointerUp);
  area.addEventListener('pointerleave',e=>{if(e.pointerType!=='touch')pointerUp(e);});
  // ã‚¿ãƒƒãƒã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’å®Œå…¨ã«æŠ‘åˆ¶
  area.addEventListener('touchstart',e=>e.preventDefault(),{passive:false});
  area.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});

  document.addEventListener('keydown',onKeyDown);document.addEventListener('keyup',onKeyUp);
  document.getElementById('pen-size').addEventListener('input',e=>{S.penSize=+e.target.value;document.getElementById('pen-size-val').textContent=S.penSize;});
  document.getElementById('pen-smooth').addEventListener('input',e=>{S.penSmooth=+e.target.value;document.getElementById('pen-smooth-val').textContent=S.penSmooth;});
  document.getElementById('pen-color').addEventListener('input',e=>{S.penColor=e.target.value;});
  document.getElementById('stroke-point-slider').addEventListener('input',onStrokePointSliderInput);
  document.querySelectorAll('.tool-btn[data-tool]').forEach(b=>{b.addEventListener('click',()=>selectTool(b.dataset.tool));});
  area.addEventListener('mousemove',e=>{const cp=document.getElementById('cursor-preview');const sz=S.penSize*S.zoom;cp.style.width=sz+'px';cp.style.height=sz+'px';cp.style.left=(e.clientX-sz/2)+'px';cp.style.top=(e.clientY-sz/2)+'px';});
  area.addEventListener('mouseenter',()=>{if(S.tool!=='point'&&S.tool!=='move'&&S.tool!=='stroke')document.getElementById('cursor-preview').style.display='block';});
  area.addEventListener('mouseleave',()=>{document.getElementById('cursor-preview').style.display='none';});
  // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼†ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³é¸æŠè§£é™¤
  document.addEventListener('click',e=>{
    hideCtxMenu();
    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚»ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠè§£é™¤
    if(!e.target.closest('.tl-cell')&&!e.target.closest('#ctx-menu')&&tlSelected.size>0){
      tlSelected.clear();updateTimeline();
    }
  });
  document.addEventListener('contextmenu',e=>{const m=document.getElementById('ctx-menu');if(m.style.display==='block'&&!m.contains(e.target))hideCtxMenu();});
}
function getPos(e){
  const a=document.getElementById('canvas-area').getBoundingClientRect();
  const ax=e.clientX-a.left,ay=e.clientY-a.top;
  // CSS: translate(pan) â†’ translate(cx,cy) â†’ rotate â†’ translate(-cx,-cy) â†’ scale
  // é€†é †: scaleâ»Â¹ â†’ translate(cx,cy) â†’ rotateâ»Â¹ â†’ translate(-cx,-cy) â†’ translate(-pan)
  // step1: translate(pan)é€†
  const tx=ax-S.panX,ty=ay-S.panY;
  // step2: translate(cx,cy)é€†
  const cx=S.cw*S.zoom/2, cy=S.ch*S.zoom/2;
  const rx=tx-cx,ry=ty-cy;
  // step3: rotateé€†
  const rad=-S.rot*Math.PI/180,cos=Math.cos(rad),sin=Math.sin(rad);
  const rrx=cos*rx-sin*ry,rry=sin*rx+cos*ry;
  // step4: translate(-cx,-cy)é€† â†’ +cx,+cy
  const sx=rrx+cx,sy=rry+cy;
  // step5: scaleé€†
  return{x:sx/S.zoom,y:sy/S.zoom};
}
function onDown(e){
  if(e.button===1){panning=true;lastMouse={x:e.clientX,y:e.clientY};return;}
  if(spaceHeld&&ctrlHeld){rotating=true;lastMouse={x:e.clientX,y:e.clientY};document.getElementById('rotation-indicator').style.display='block';return;}
  if(spaceHeld||viewTool==='pan'){panning=true;lastMouse={x:e.clientX,y:e.clientY};return;}
  if(viewTool==='rotate'){rotating=true;lastMouse={x:e.clientX,y:e.clientY};document.getElementById('rotation-indicator').style.display='block';return;}
  if(e.button!==0)return;const p=getPos(e);

  // ãƒã‚¤ãƒ³ãƒˆç·¨é›†ãƒ„ãƒ¼ãƒ«
  if(S.tool==='point'){onDownPoint(p,e);return;}
  // ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç·¨é›†ãƒ„ãƒ¼ãƒ«
  if(S.tool==='stroke'){onDownStroke(p,e);return;}
  // ç§»å‹•ãƒ„ãƒ¼ãƒ«
  if(S.tool==='move'){onDownMove(p,e);return;}

  if(S.tool==='pen'||S.tool==='eraser'){drawing=true;curPoints=[{x:p.x,y:p.y}];pushUndo();drawingSnapshot=layerCtxs[S.layer].getImageData(0,0,S.cw,S.ch);}
  else if(S.tool==='line'||S.tool==='circle'||S.tool==='rect'){drawing=true;shapeStart={x:p.x,y:p.y};pushUndo();drawingSnapshot=layerCtxs[S.layer].getImageData(0,0,S.cw,S.ch);}
}
function onMove(e){
  if(panning){S.panX+=e.clientX-lastMouse.x;S.panY+=e.clientY-lastMouse.y;lastMouse={x:e.clientX,y:e.clientY};updateTransform();return;}
  if(rotating){S.rot+=(e.clientX-lastMouse.x)*0.5;lastMouse={x:e.clientX,y:e.clientY};document.getElementById('rotation-indicator').textContent=Math.round(S.rot)+'Â°';updateTransform();return;}

  const p=getPos(e);
  // ãƒã‚¤ãƒ³ãƒˆç·¨é›†ãƒ„ãƒ¼ãƒ«
  if(S.tool==='point'){onMovePoint(p,e);return;}
  // ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç·¨é›†ãƒ„ãƒ¼ãƒ«
  if(S.tool==='stroke'){onMoveStroke(p,e);return;}
  // ç§»å‹•ãƒ„ãƒ¼ãƒ«
  if(S.tool==='move'){onMoveMove(p,e);return;}

  if(!drawing)return;
  if(S.tool==='pen'||S.tool==='eraser'){curPoints.push({x:p.x,y:p.y});renderStrokePreview();}else renderShapePreview(p);
}
function onUp(e){
  if(panning){panning=false;return;}if(rotating){rotating=false;document.getElementById('rotation-indicator').style.display='none';return;}

  const p=getPos(e);
  // ãƒã‚¤ãƒ³ãƒˆç·¨é›†ãƒ„ãƒ¼ãƒ«
  if(S.tool==='point'){onUpPoint(p,e);return;}
  // ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç·¨é›†ãƒ„ãƒ¼ãƒ«
  if(S.tool==='stroke'){onUpStroke(p,e);return;}
  // ç§»å‹•ãƒ„ãƒ¼ãƒ«
  if(S.tool==='move'){onUpMove(p,e);return;}

  if(!drawing)return;drawing=false;const fr=CF()[S.layer].frames[S.frame];
  if(S.tool==='pen'&&curPoints.length>=2){const sm=smoothPoints(curPoints);fr.strokes.push({type:'bezier',controls:toBezier(sm),color:S.penColor,size:S.penSize,order:fr.strokes.length});}
  else if(S.tool==='eraser'&&curPoints.length>=2){
    // æ¶ˆã—ã‚´ãƒ ï¼šã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®ãƒ‘ã‚¹ã‚’ç›´æ¥å‰Šé™¤ã™ã‚‹æ–¹å¼
    applyEraserToStrokes(fr,curPoints,S.penSize*3);
  }
  else if(S.tool==='line'&&shapeStart){fr.strokes.push({type:'line',x1:shapeStart.x,y1:shapeStart.y,x2:p.x,y2:p.y,color:S.penColor,size:S.penSize,order:fr.strokes.length});}
  else if(S.tool==='circle'&&shapeStart){fr.strokes.push({type:'ellipse',cx:(shapeStart.x+p.x)/2,cy:(shapeStart.y+p.y)/2,rx:Math.abs(p.x-shapeStart.x)/2,ry:Math.abs(p.y-shapeStart.y)/2,color:S.penColor,size:S.penSize,order:fr.strokes.length});}
  else if(S.tool==='rect'&&shapeStart){fr.strokes.push({type:'rect',x:Math.min(shapeStart.x,p.x),y:Math.min(shapeStart.y,p.y),w:Math.abs(p.x-shapeStart.x),h:Math.abs(p.y-shapeStart.y),color:S.penColor,size:S.penSize,order:fr.strokes.length});}
  curPoints=[];shapeStart=null;drawingSnapshot=null;renderAll();updateTimeline();
}
function onWheel(e){e.preventDefault();const a=document.getElementById('canvas-area').getBoundingClientRect();const mx=e.clientX-a.left,my=e.clientY-a.top;const old=S.zoom;S.zoom=Math.max(0.1,Math.min(10,S.zoom*(e.deltaY>0?0.9:1.1)));S.panX=mx-(mx-S.panX)*(S.zoom/old);S.panY=my-(my-S.panY)*(S.zoom/old);updateTransform();}
function onKeyDown(e){
  if(e.code==='Space'){spaceHeld=true;e.preventDefault();}
  if(e.ctrlKey||e.metaKey)ctrlHeld=true;
  if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){e.preventDefault();undoAction();}
  if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.key==='z'&&e.shiftKey))){e.preventDefault();redoAction();}
  if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();saveProject();}
  if((e.ctrlKey||e.metaKey)&&e.key==='c'&&!e.shiftKey){ctxLayer=S.layer;ctxFrame=S.frame;ctxCopyFrame();}
  if((e.ctrlKey||e.metaKey)&&e.key==='v'&&!e.shiftKey){ctxLayer=S.layer;ctxFrame=S.frame;ctxPasteFrame();}
  if(!e.ctrlKey&&!e.metaKey){if(e.key==='p')selectTool('pen');if(e.key==='l')selectTool('line');if(e.key==='c')selectTool('circle');if(e.key==='r')selectTool('rect');if(e.key==='e')selectTool('eraser');if(e.key==='a')selectTool('point');if(e.key==='s')selectTool('stroke');if(e.key==='v')selectTool('move');}
  if(e.key==='ArrowRight')goNextFrame();if(e.key==='ArrowLeft')goPrevFrame();
  if(e.key==='Escape'){S.rot=0;updateTransform();}
  // Delete/Backspaceã§ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯å‰Šé™¤ï¼ˆã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç·¨é›†ãƒ„ãƒ¼ãƒ«æ™‚ï¼‰
  if((e.key==='Delete'||e.key==='Backspace')&&S.tool==='stroke'&&strokeEditIdx>=0){
    e.preventDefault();const fr=CF()[S.layer].frames[S.frame];
    if(fr&&strokeEditIdx<fr.strokes.length){pushUndo();fr.strokes.splice(strokeEditIdx,1);strokeEditIdx=-1;strokeEditCorners=null;strokeEditCenter=null;renderAll();updateTimeline();notify('ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚’å‰Šé™¤');}
  }
  // Delete/Backspaceã§ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³é¸æŠã‚»ãƒ«ã‚’ä¸€æ‹¬ã‚¯ãƒªã‚¢
  if((e.key==='Delete'||e.key==='Backspace')&&tlSelected.size>0&&S.tool!=='stroke'){
    e.preventDefault();pushUndo();
    for(const k of tlSelected){
      const p=k.split('-');const li=+p[0],fi=+p[1];
      CF()[li].frames[fi]={strokes:[],draftImg:null};
      delete CFD()[li+'-'+fi];
    }
    tlSelected.clear();renderAll();updateTimeline();notify('é¸æŠãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢');
  }
  // Escã§é¸æŠè§£é™¤
  if(e.key==='Escape'&&tlSelected.size>0){tlSelected.clear();updateTimeline();}
}
function onKeyUp(e){if(e.code==='Space')spaceHeld=false;if(!e.ctrlKey&&!e.metaKey)ctrlHeld=false;}
function selectTool(t){
  S.tool=t;document.querySelectorAll('.tool-btn[data-tool]').forEach(b=>b.classList.toggle('active',b.dataset.tool===t));
  // ãƒ„ãƒ¼ãƒ«åˆ‡æ›¿æ™‚ã«ãƒã‚¤ãƒ³ãƒˆç·¨é›†çŠ¶æ…‹ã‚¯ãƒªã‚¢
  if(t!=='point'){selectedStrokeIdx=-1;dragPointInfo=null;selectedPointInfo=null;}
  if(t!=='stroke'){strokeEditIdx=-1;strokeEditMode='';strokeEditCorners=null;strokeEditCenter=null;strokeEditAnchor=null;}
  if(t!=='move'){moveDragging=false;moveTargetIdx=-1;}
  // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ä¸‹éƒ¨ãƒ‘ãƒãƒ«åˆ‡æ›¿
  document.getElementById('pen-settings').style.display=(t==='pen'||t==='line'||t==='circle'||t==='rect'||t==='eraser')?'':'none';
  document.getElementById('stroke-point-settings').style.display=(t==='stroke'||t==='point')?'':'none';
  updateStrokePointSlider();
  renderAll();
  // ã‚«ãƒ¼ã‚½ãƒ«å¤‰æ›´
  const area=document.getElementById('canvas-area');
  const cp=document.getElementById('cursor-preview');
  if(t==='point'||t==='stroke'){area.style.cursor='default';cp.style.display='none';}
  else if(t==='move'){area.style.cursor='move';cp.style.display='none';}
  else{area.style.cursor='crosshair';cp.style.display='';}
}

// ===========================================================
// ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å³ã‚¯ãƒªãƒƒã‚¯ï¼‰
// ===========================================================
function showCtxMenu(e,li,fi){
  e.preventDefault();e.stopPropagation();
  ctxLayer=li;ctxFrame=fi;
  const m=document.getElementById('ctx-menu');
  document.getElementById('ctx-paste').classList.toggle('disabled',!clipFrame);
  document.getElementById('ctx-paste-all').classList.toggle('disabled',!clipAllFrames);
  m.style.display='block';m.style.left=e.clientX+'px';m.style.top=e.clientY+'px';
  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†èª¿æ•´
  const rect=m.getBoundingClientRect();
  if(rect.right>window.innerWidth)m.style.left=(e.clientX-rect.width)+'px';
  if(rect.bottom>window.innerHeight)m.style.top=(e.clientY-rect.height)+'px';
}
function hideCtxMenu(){document.getElementById('ctx-menu').style.display='none';}

function ctxCopyFrame(){
  const fr=CF()[ctxLayer].frames[ctxFrame];
  clipFrame=JSON.parse(JSON.stringify(fr));
  hideCtxMenu();notify(`ãƒ¬ã‚¤ãƒ¤ãƒ¼${ctxLayer+1} ãƒ•ãƒ¬ãƒ¼ãƒ ${ctxFrame+1} ã‚’ã‚³ãƒ”ãƒ¼`);
}
function ctxPasteFrame(){
  if(!clipFrame){notify('ã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“');hideCtxMenu();return;}
  pushUndo();
  CF()[ctxLayer].frames[ctxFrame]=JSON.parse(JSON.stringify(clipFrame));
  hideCtxMenu();renderAll();updateTimeline();notify(`ãƒ•ãƒ¬ãƒ¼ãƒ ${ctxFrame+1} ã«è²¼ã‚Šä»˜ã‘`);
}
function ctxCopyAllLayers(){
  clipAllFrames=[];
  for(let li=0;li<LAYER_DEFS.length;li++){clipAllFrames.push(JSON.parse(JSON.stringify(CF()[li].frames[ctxFrame])));}
  hideCtxMenu();notify(`å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ ãƒ•ãƒ¬ãƒ¼ãƒ ${ctxFrame+1} ã‚’ã‚³ãƒ”ãƒ¼`);
}
function ctxPasteAllLayers(){
  if(!clipAllFrames){notify('ã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“');hideCtxMenu();return;}
  pushUndo();
  for(let li=0;li<LAYER_DEFS.length;li++){if(clipAllFrames[li])CF()[li].frames[ctxFrame]=JSON.parse(JSON.stringify(clipAllFrames[li]));}
  hideCtxMenu();renderAll();updateTimeline();notify(`å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ ãƒ•ãƒ¬ãƒ¼ãƒ ${ctxFrame+1} ã«è²¼ã‚Šä»˜ã‘`);
}
function ctxClearFrame(){
  pushUndo();
  CF()[ctxLayer].frames[ctxFrame]={strokes:[],draftImg:null};
  hideCtxMenu();renderAll();updateTimeline();notify(`ãƒ•ãƒ¬ãƒ¼ãƒ ${ctxFrame+1} ã‚’ã‚¯ãƒªã‚¢`);
}
function ctxInsertFrame(){
  pushUndo();const f=ctxFrame+1;
  for(let i=0;i<LAYER_DEFS.length;i++)CF()[i].frames.splice(f,0,{strokes:[],draftImg:null});
  CC().totalFrames++;hideCtxMenu();goToFrame(f);notify('ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æŒ¿å…¥');
}
function ctxSetDuration(){
  hideCtxMenu();
  document.getElementById('dur-modal-input').value=CFD()[ctxLayer+'-'+ctxFrame]||1;
  document.getElementById('duration-modal').classList.add('show');
}
function applyDurModal(){
  const v=+document.getElementById('dur-modal-input').value;
  if(v>=1)CFD()[ctxLayer+'-'+ctxFrame]=v;
  closeModal('duration-modal');updateTimeline();notify(`ãƒ•ãƒ¬ãƒ¼ãƒ ${ctxFrame+1} â†’ ${v}fæŒç¶š`);
}

// ===========================================================
// ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚° & ãƒ™ã‚¸ã‚§
// ===========================================================
function smoothPoints(pts){
  if(pts.length<3)return pts;
  const totalLen=pathLength(pts);if(totalLen<2)return pts;
  const sv=S.penSmooth/100; // 0.0ã€œ1.0
  // sv=0: è£œæ­£ãªã—ï¼ˆé–“å¼•ãã®ã¿æœ€å°é™ï¼‰
  if(sv===0){
    // è·é›¢ãƒ™ãƒ¼ã‚¹ã§æœ€ä½é™ãƒªã‚µãƒ³ãƒ—ãƒ«ï¼ˆ1pxé–“éš”ã‚’ã¾ã¨ã‚ã‚‹ç¨‹åº¦ï¼‰
    const re=resamplePath(pts,Math.max(3,Math.floor(totalLen/1.5)));
    return rdp(re,0.3);
  }
  // ãƒªã‚µãƒ³ãƒ—ãƒ«é–“éš”: sv=0â†’1.5px, sv=1â†’6px
  const spacing=1.5+sv*4.5;
  const numSamples=Math.max(3,Math.floor(totalLen/spacing));
  const re=resamplePath(pts,numSamples);
  // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°å¼·åº¦: sv=0â†’0, sv=1â†’0.35ï¼ˆå‰å¾Œã®é‡ã¿ï¼‰
  const w=sv*0.35;
  const r=[re[0]];
  for(let i=1;i<re.length-1;i++){
    const p=re[i-1],c=re[i],n=re[i+1];
    r.push({x:p.x*w+c.x*(1-2*w)+n.x*w,y:p.y*w+c.y*(1-2*w)+n.y*w});
  }
  r.push(re[re.length-1]);
  // RDPé–¾å€¤: sv=0â†’0.3, sv=1â†’1.5
  const rdpEp=0.3+sv*1.2;
  return rdp(r,rdpEp);
}
function pathLength(pts){let l=0;for(let i=1;i<pts.length;i++)l+=Math.hypot(pts[i].x-pts[i-1].x,pts[i].y-pts[i-1].y);return l;}
function resamplePath(pts,n){
  const tl=pathLength(pts);if(tl===0||n<2)return[pts[0],pts[pts.length-1]];
  const step=tl/(n-1);const r=[pts[0]];let idx=0,carry=0;
  for(let i=1;i<n-1;i++){let target=step*i;while(idx<pts.length-1){const sl=Math.hypot(pts[idx+1].x-pts[idx].x,pts[idx+1].y-pts[idx].y);if(carry+sl>=target){const t=(target-carry)/sl;r.push({x:pts[idx].x+(pts[idx+1].x-pts[idx].x)*t,y:pts[idx].y+(pts[idx+1].y-pts[idx].y)*t});break;}carry+=sl;idx++;}}
  r.push(pts[pts.length-1]);return r;
}
function rdp(pts,ep){if(pts.length<=2)return pts;let mx=0,mi=0;const f=pts[0],l=pts[pts.length-1];for(let i=1;i<pts.length-1;i++){const d=ptLineDist(pts[i],f,l);if(d>mx){mx=d;mi=i;}}if(mx>ep){const a=rdp(pts.slice(0,mi+1),ep);const b=rdp(pts.slice(mi),ep);return a.slice(0,-1).concat(b);}return[f,l];}
function ptLineDist(p,a,b){const dx=b.x-a.x,dy=b.y-a.y,ls=dx*dx+dy*dy;if(ls===0)return Math.hypot(p.x-a.x,p.y-a.y);let t=((p.x-a.x)*dx+(p.y-a.y)*dy)/ls;t=Math.max(0,Math.min(1,t));return Math.hypot(p.x-(a.x+t*dx),p.y-(a.y+t*dy));}
function toBezier(pts){
  if(pts.length<2)return[];if(pts.length===2)return[{sx:pts[0].x,sy:pts[0].y,cx:(pts[0].x+pts[1].x)/2,cy:(pts[0].y+pts[1].y)/2,ex:pts[1].x,ey:pts[1].y}];
  const c=[];c.push({sx:pts[0].x,sy:pts[0].y,cx:pts[0].x,cy:pts[0].y,ex:(pts[0].x+pts[1].x)/2,ey:(pts[0].y+pts[1].y)/2});
  for(let i=1;i<pts.length-1;i++)c.push({sx:(pts[i-1].x+pts[i].x)/2,sy:(pts[i-1].y+pts[i].y)/2,cx:pts[i].x,cy:pts[i].y,ex:(pts[i].x+pts[i+1].x)/2,ey:(pts[i].y+pts[i+1].y)/2});
  const n=pts.length-1;c.push({sx:(pts[n-1].x+pts[n].x)/2,sy:(pts[n-1].y+pts[n].y)/2,cx:pts[n].x,cy:pts[n].y,ex:pts[n].x,ey:pts[n].y});return c;
}

// ===========================================================
// æ¶ˆã—ã‚´ãƒ ï¼šã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®ãƒ‘ã‚¹ã‚’ç›´æ¥å‰Šé™¤ã™ã‚‹æ–¹å¼
// ===========================================================
function applyEraserToStrokes(fr,eraserPts,eraserSize){
  // æ¶ˆã—ã‚´ãƒ ãƒ‘ã‚¹ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦ç‚¹åˆ—åŒ–
  const ePts=[];
  for(let i=0;i<eraserPts.length;i++){
    ePts.push({x:eraserPts[i].x,y:eraserPts[i].y});
    if(i<eraserPts.length-1){
      // ä¸­é–“ç‚¹ã‚‚è¿½åŠ ï¼ˆå¯†ãªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰
      const a=eraserPts[i],b=eraserPts[i+1];
      const dx=b.x-a.x,dy=b.y-a.y;
      const d=Math.sqrt(dx*dx+dy*dy);
      const step=eraserSize/3;
      if(d>step){
        const n=Math.ceil(d/step);
        for(let j=1;j<n;j++){ePts.push({x:a.x+dx*j/n,y:a.y+dy*j/n});}
      }
    }
  }
  const r=eraserSize/2;
  const r2=r*r;
  const newStrokes=[];
  for(const s of fr.strokes){
    if(s.type==='eraser')continue; // æ—¢å­˜ã®eraserã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã¯ç„¡è¦–ï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿äº’æ›ï¼‰
    if(s.type==='bezier'&&s.controls&&s.controls.length>0){
      // ãƒ™ã‚¸ã‚§ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚’ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã«åˆ¤å®š
      const surviving=eraseBezierSegments(s.controls,ePts,r2,s.size);
      for(const seg of surviving){
        if(seg.length>0){
          newStrokes.push({type:'bezier',controls:seg,color:s.color,size:s.size,order:newStrokes.length});
        }
      }
    }else if(s.type==='line'){
      // ç›´ç·šï¼šã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦æ¶ˆã—ã‚´ãƒ ã¨ã®äº¤å·®åˆ¤å®š
      const pts=sampleLine(s.x1,s.y1,s.x2,s.y2,r);
      const surviving=erasePointSequence(pts,ePts,r2,s.size);
      for(const seg of surviving){
        if(seg.length>=2){
          newStrokes.push({type:'line',x1:seg[0].x,y1:seg[0].y,x2:seg[seg.length-1].x,y2:seg[seg.length-1].y,color:s.color,size:s.size,order:newStrokes.length});
        }
      }
    }else if(s.type==='ellipse'){
      // æ¥•å††ï¼šæ¶ˆã—ã‚´ãƒ ãŒæ¥•å††ã®ä¸­å¿ƒä»˜è¿‘ã«è§¦ã‚ŒãŸã‚‰å‰Šé™¤
      const hit=ePts.some(p=>{
        const dx=p.x-s.cx,dy=p.y-s.cy;
        return dx*dx+dy*dy<(Math.max(s.rx,s.ry)+r)*(Math.max(s.rx,s.ry)+r);
      });
      if(!hit)newStrokes.push({...s,order:newStrokes.length});
    }else if(s.type==='rect'){
      // çŸ©å½¢ï¼šæ¶ˆã—ã‚´ãƒ ãŒçŸ©å½¢é ˜åŸŸã«è§¦ã‚ŒãŸã‚‰å‰Šé™¤
      const hit=ePts.some(p=>p.x+r>s.x&&p.x-r<s.x+s.w&&p.y+r>s.y&&p.y-r<s.y+s.h);
      if(!hit)newStrokes.push({...s,order:newStrokes.length});
    }else{
      newStrokes.push({...s,order:newStrokes.length});
    }
  }
  fr.strokes=newStrokes;
}

function eraseBezierSegments(controls,ePts,r2,strokeSize){
  // å„ãƒ™ã‚¸ã‚§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã€æ¶ˆã—ã‚´ãƒ ã«è§¦ã‚ŒãŸç®‡æ‰€ã§åˆ†å‰²
  // ã¾ãšå…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ³ãƒˆåˆ—åŒ–
  const allPts=[];
  const segBounds=[]; // å„åˆ¶å¾¡ç‚¹ã®å…ˆé ­ãƒã‚¤ãƒ³ãƒˆindex
  for(let i=0;i<controls.length;i++){
    const c=controls[i];
    segBounds.push(allPts.length);
    const steps=8;
    for(let t=0;t<=steps;t++){
      const tt=t/steps;
      const u=1-tt;
      const x=u*u*c.sx+2*u*tt*c.cx+tt*tt*c.ex;
      const y=u*u*c.sy+2*u*tt*c.cy+tt*tt*c.ey;
      // é‡è¤‡å›é¿
      if(allPts.length>0&&t===0)continue;
      allPts.push({x,y,ci:i,t:tt});
    }
  }
  // å„ãƒã‚¤ãƒ³ãƒˆãŒæ¶ˆã—ã‚´ãƒ ã«è§¦ã‚Œã¦ã„ã‚‹ã‹åˆ¤å®š
  const halfStroke=strokeSize/2;
  const hitRadius2=(Math.sqrt(r2)+halfStroke)*(Math.sqrt(r2)+halfStroke);
  const erased=new Array(allPts.length).fill(false);
  for(let i=0;i<allPts.length;i++){
    const p=allPts[i];
    for(const ep of ePts){
      const dx=p.x-ep.x,dy=p.y-ep.y;
      if(dx*dx+dy*dy<hitRadius2){erased[i]=true;break;}
    }
  }
  // é€£ç¶šã™ã‚‹éæ¶ˆå»åŒºé–“ã‚’æŠ½å‡º
  const segments=[];
  let start=-1;
  for(let i=0;i<=allPts.length;i++){
    if(i<allPts.length&&!erased[i]){
      if(start===-1)start=i;
    }else{
      if(start!==-1){
        // start..i-1 ãŒæ®‹ã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
        const pts=allPts.slice(start,i);
        if(pts.length>=2){
          // ãƒã‚¤ãƒ³ãƒˆåˆ—ã‹ã‚‰ãƒ™ã‚¸ã‚§åˆ¶å¾¡ç‚¹ã‚’å†æ§‹ç¯‰
          const rawPts=pts.map(p=>({x:p.x,y:p.y}));
          segments.push(toBezier(rawPts));
        }
        start=-1;
      }
    }
  }
  return segments;
}

function sampleLine(x1,y1,x2,y2,r){
  const dx=x2-x1,dy=y2-y1;
  const d=Math.sqrt(dx*dx+dy*dy);
  const step=r/2;
  const n=Math.max(2,Math.ceil(d/step));
  const pts=[];
  for(let i=0;i<=n;i++){
    pts.push({x:x1+dx*i/n,y:y1+dy*i/n});
  }
  return pts;
}

function erasePointSequence(pts,ePts,r2,strokeSize){
  const halfStroke=strokeSize/2;
  const hitRadius2=(Math.sqrt(r2)+halfStroke)*(Math.sqrt(r2)+halfStroke);
  const erased=new Array(pts.length).fill(false);
  for(let i=0;i<pts.length;i++){
    const p=pts[i];
    for(const ep of ePts){
      const dx=p.x-ep.x,dy=p.y-ep.y;
      if(dx*dx+dy*dy<hitRadius2){erased[i]=true;break;}
    }
  }
  const segments=[];
  let start=-1;
  for(let i=0;i<=pts.length;i++){
    if(i<pts.length&&!erased[i]){
      if(start===-1)start=i;
    }else{
      if(start!==-1){segments.push(pts.slice(start,i));start=-1;}
    }
  }
  return segments;
}

// ===========================================================
// æç”»
// ===========================================================
function renderAll(){
  for(let i=0;i<LAYER_DEFS.length;i++){renderLayer(i,S.frame);layerCanvases[i].style.display=layerVis[i]?'block':'none';}
  renderOnion();renderStrokeGuide();renderPointEditOverlay();renderStrokeEditOverlay();
  updateStrokePointSlider();updateFrameGuide();
}

function updateFrameGuide(){
  const el=document.getElementById('frame-guide-overlay');
  const enabled=document.getElementById('frame-guide-enabled').checked;
  if(!enabled){el.style.display='none';return;}
  frameGuideW=+document.getElementById('frame-guide-w').value||1920;
  frameGuideH=+document.getElementById('frame-guide-h').value||1080;
  const left=(S.cw-frameGuideW)/2;
  const top=(S.ch-frameGuideH)/2;
  el.style.display='block';
  el.style.left=left+'px';el.style.top=top+'px';
  el.style.width=frameGuideW+'px';el.style.height=frameGuideH+'px';
}
function renderLayer(li,fi){
  const ctx=layerCtxs[li];
  const isDraft=LAYER_DEFS[li].type==='draft';
  // ä¸‹æ›¸ããƒ¬ã‚¤ãƒ¤ãƒ¼ã¯CSS opacityã§å…¨æç”»ï¼ˆç”»åƒ+ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ï¼‰ã«ä¸é€æ˜åº¦é©ç”¨
  layerCanvases[li].style.opacity=isDraft?draftOpacity:1;

  if(fi<0||fi>=CF()[li].frames.length){ctx.clearRect(0,0,S.cw,S.ch);return;}
  const fr=getEffectiveFrame(li,fi);
  if(!fr){ctx.clearRect(0,0,S.cw,S.ch);return;}

  if(fr.draftImg){
    const eidx=getEffectiveFrameIdx(li,fi);
    const key=currentCut+'-'+li+'-'+eidx;
    const drawWithImg=(img)=>{
      ctx.clearRect(0,0,S.cw,S.ch);
      ctx.drawImage(img,0,0,S.cw,S.ch);
      drawStrokes(ctx,fr.strokes);if(!isDraft)binarizeCanvas(ctx,S.cw,S.ch);
    };
    if(draftImgCache[key]&&draftImgCache[key].src===fr.draftImg){
      drawWithImg(draftImgCache[key]);
    }else{
      const img=new Image();img.onload=()=>{
        draftImgCache[key]=img;drawWithImg(img);
      };img.src=fr.draftImg;
    }
    return;
  }
  ctx.clearRect(0,0,S.cw,S.ch);
  drawStrokes(ctx,fr.strokes);if(!isDraft)binarizeCanvas(ctx,S.cw,S.ch);
}
function drawStrokes(ctx,strokes){
  for(const s of strokes){
    if(s.type==='eraser')continue; // æ—§ãƒ‡ãƒ¼ã‚¿äº’æ›ï¼šeraserã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã¯ç„¡è¦–
    drawStroke(ctx,s);
  }
}
function drawStroke(ctx,s){
  ctx.lineCap='square';ctx.lineJoin='miter';
  if(s.type==='bezier'){ctx.globalCompositeOperation='source-over';ctx.strokeStyle=s.color;ctx.lineWidth=s.size;ctx.beginPath();if(s.controls.length>0){ctx.moveTo(s.controls[0].sx,s.controls[0].sy);for(const c of s.controls)ctx.quadraticCurveTo(c.cx,c.cy,c.ex,c.ey);}ctx.stroke();}
  else if(s.type==='eraser'){ctx.globalCompositeOperation='destination-out';ctx.strokeStyle='#fff';ctx.lineWidth=s.size;ctx.beginPath();if(s.controls&&s.controls.length>0){ctx.moveTo(s.controls[0].sx,s.controls[0].sy);for(const c of s.controls)ctx.quadraticCurveTo(c.cx,c.cy,c.ex,c.ey);}ctx.stroke();ctx.globalCompositeOperation='source-over';}
  else if(s.type==='line'){ctx.globalCompositeOperation='source-over';ctx.strokeStyle=s.color;ctx.lineWidth=s.size;ctx.beginPath();ctx.moveTo(s.x1,s.y1);ctx.lineTo(s.x2,s.y2);ctx.stroke();}
  else if(s.type==='ellipse'){ctx.globalCompositeOperation='source-over';ctx.strokeStyle=s.color;ctx.lineWidth=s.size;ctx.beginPath();ctx.ellipse(s.cx,s.cy,Math.max(1,s.rx),Math.max(1,s.ry),0,0,Math.PI*2);ctx.stroke();}
  else if(s.type==='rect'){ctx.globalCompositeOperation='source-over';ctx.strokeStyle=s.color;ctx.lineWidth=s.size;ctx.beginPath();ctx.rect(s.x,s.y,s.w,s.h);ctx.stroke();}
}
// äºŒå€¤åŒ–ï¼šã‚¢ãƒ«ãƒ•ã‚¡å€¤ã‚’é–¾å€¤ã§0ã‹255ã«å¤‰æ›ï¼ˆã‚¢ãƒ³ãƒã‚¨ã‚¤ãƒªã‚¢ã‚¹é™¤å»ï¼‰
function binarizeCanvas(ctx,w,h){
  const imgData=ctx.getImageData(0,0,w,h);
  const d=imgData.data;
  const threshold=128;
  for(let i=3;i<d.length;i+=4){
    d[i]=d[i]>=threshold?255:0;
  }
  ctx.putImageData(imgData,0,0);
}
function renderStrokePreview(){
  const ctx=layerCtxs[S.layer];
  if(drawingSnapshot){ctx.putImageData(drawingSnapshot,0,0);}else{renderLayer(S.layer,S.frame);}
  if(curPoints.length<2)return;
  ctx.lineCap='square';ctx.lineJoin='miter';
  if(S.tool==='eraser'){ctx.globalCompositeOperation='destination-out';ctx.strokeStyle='#fff';ctx.lineWidth=S.penSize*3;}
  else{ctx.globalCompositeOperation='source-over';ctx.strokeStyle=S.penColor;ctx.lineWidth=S.penSize;}
  ctx.beginPath();ctx.moveTo(curPoints[0].x,curPoints[0].y);for(let i=1;i<curPoints.length;i++)ctx.lineTo(curPoints[i].x,curPoints[i].y);ctx.stroke();ctx.globalCompositeOperation='source-over';
  const isDraft=LAYER_DEFS[S.layer].type==='draft';
  if(!isDraft)binarizeCanvas(ctx,S.cw,S.ch);
}
function renderShapePreview(p){
  const ctx=layerCtxs[S.layer];
  if(drawingSnapshot){ctx.putImageData(drawingSnapshot,0,0);}else{renderLayer(S.layer,S.frame);}
  if(!shapeStart)return;
  ctx.strokeStyle=S.penColor;ctx.lineWidth=S.penSize;ctx.lineCap='square';ctx.lineJoin='miter';
  if(S.tool==='line'){ctx.beginPath();ctx.moveTo(shapeStart.x,shapeStart.y);ctx.lineTo(p.x,p.y);ctx.stroke();}
  else if(S.tool==='circle'){ctx.beginPath();ctx.ellipse((shapeStart.x+p.x)/2,(shapeStart.y+p.y)/2,Math.max(1,Math.abs(p.x-shapeStart.x)/2),Math.max(1,Math.abs(p.y-shapeStart.y)/2),0,0,Math.PI*2);ctx.stroke();}
  else if(S.tool==='rect'){ctx.beginPath();ctx.rect(Math.min(shapeStart.x,p.x),Math.min(shapeStart.y,p.y),Math.abs(p.x-shapeStart.x),Math.abs(p.y-shapeStart.y));ctx.stroke();}
  const isDraft=LAYER_DEFS[S.layer].type==='draft';
  if(!isDraft)binarizeCanvas(ctx,S.cw,S.ch);
}

// ===========================================================
// ãƒã‚¤ãƒ³ãƒˆç·¨é›†ãƒ„ãƒ¼ãƒ«ï¼ˆã‚¯ãƒªã‚¹ã‚¿é¢¨ï¼šé€šéç‚¹ã®ã¿è¡¨ç¤ºãƒ»ç§»å‹•ï¼‰
// ===========================================================
// ãƒ™ã‚¸ã‚§ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®é€šéç‚¹ï¼ˆãƒ‘ã‚¹ä¸Šã®ç‚¹ï¼‰ã‚’å–å¾—
function getStrokePathPoints(strokes,filterIdx){
  const pts=[];
  const list=(filterIdx>=0)?[{s:strokes[filterIdx],i:filterIdx}]:strokes.map((s,i)=>({s,i}));
  for(const {s,i} of list){
    if(s.type==='bezier'||s.type==='eraser'){
      if(!s.controls||s.controls.length===0)continue;
      // æœ€åˆã®å§‹ç‚¹
      pts.push({x:s.controls[0].sx,y:s.controls[0].sy,strokeIdx:i,type:'bezier',idx:0,sub:'s'});
      // å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®çµ‚ç‚¹ï¼ˆï¼æ¬¡ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å§‹ç‚¹ã§ã‚‚ã‚ã‚‹é€šéç‚¹ï¼‰
      for(let ci=0;ci<s.controls.length;ci++){
        pts.push({x:s.controls[ci].ex,y:s.controls[ci].ey,strokeIdx:i,type:'bezier',idx:ci,sub:'e'});
      }
    }else if(s.type==='line'){
      pts.push({x:s.x1,y:s.y1,strokeIdx:i,type:'line',idx:0,sub:'s'});
      pts.push({x:s.x2,y:s.y2,strokeIdx:i,type:'line',idx:0,sub:'e'});
    }else if(s.type==='ellipse'){
      pts.push({x:s.cx,y:s.cy,strokeIdx:i,type:'ellipse',idx:0,sub:'center'});
      pts.push({x:s.cx+s.rx,y:s.cy,strokeIdx:i,type:'ellipse',idx:0,sub:'rx'});
      pts.push({x:s.cx,y:s.cy-s.ry,strokeIdx:i,type:'ellipse',idx:0,sub:'ry'});
    }else if(s.type==='rect'){
      pts.push({x:s.x,y:s.y,strokeIdx:i,type:'rect',idx:0,sub:'tl'});
      pts.push({x:s.x+s.w,y:s.y,strokeIdx:i,type:'rect',idx:0,sub:'tr'});
      pts.push({x:s.x+s.w,y:s.y+s.h,strokeIdx:i,type:'rect',idx:0,sub:'br'});
      pts.push({x:s.x,y:s.y+s.h,strokeIdx:i,type:'rect',idx:0,sub:'bl'});
    }
  }
  return pts;
}

function findNearestPoint(pts,p,threshold){
  let best=null,bestDist=threshold;
  for(const pt of pts){
    const d=Math.hypot(pt.x-p.x,pt.y-p.y);
    if(d<bestDist){bestDist=d;best=pt;}
  }
  return best;
}

function hitTestStroke(strokes,p,threshold){
  for(let i=strokes.length-1;i>=0;i--){
    const s=strokes[i];
    if(s.type==='bezier'||s.type==='eraser'){
      if(!s.controls)continue;
      for(const c of s.controls){
        for(let t=0;t<=1;t+=0.05){
          const bx=(1-t)*(1-t)*c.sx+2*(1-t)*t*c.cx+t*t*c.ex;
          const by=(1-t)*(1-t)*c.sy+2*(1-t)*t*c.cy+t*t*c.ey;
          if(Math.hypot(bx-p.x,by-p.y)<threshold+s.size/2)return i;
        }
      }
    }else if(s.type==='line'){
      const d=ptLineDist(p,{x:s.x1,y:s.y1},{x:s.x2,y:s.y2});
      if(d<threshold+s.size/2)return i;
    }else if(s.type==='ellipse'){
      const dx=(p.x-s.cx)/Math.max(1,s.rx),dy=(p.y-s.cy)/Math.max(1,s.ry);
      const dist=Math.sqrt(dx*dx+dy*dy);
      if(Math.abs(dist-1)*Math.max(s.rx,s.ry)<threshold+s.size/2)return i;
    }else if(s.type==='rect'){
      const inX=p.x>=s.x-threshold&&p.x<=s.x+s.w+threshold;
      const inY=p.y>=s.y-threshold&&p.y<=s.y+s.h+threshold;
      const nearL=Math.abs(p.x-s.x)<threshold+s.size/2;
      const nearR=Math.abs(p.x-(s.x+s.w))<threshold+s.size/2;
      const nearT=Math.abs(p.y-s.y)<threshold+s.size/2;
      const nearB=Math.abs(p.y-(s.y+s.h))<threshold+s.size/2;
      if((inY&&(nearL||nearR))||(inX&&(nearT||nearB)))return i;
    }
  }
  return -1;
}

// é€šéç‚¹ç§»å‹•ï¼šCatmull-Romã§éš£æ¥åˆ¶å¾¡ç‚¹ã‚’è‡ªå‹•å†è¨ˆç®—ã—æ»‘ã‚‰ã‹ãªã‚«ãƒ¼ãƒ–ã‚’ç¶­æŒ
function movePathPoint(strokes,info,nx,ny){
  const s=strokes[info.strokeIdx];
  if(info.type==='bezier'){
    const ctrls=s.controls;
    if(info.sub==='c'){
      // åˆ¶å¾¡ç‚¹ï¼ˆãƒ™ã‚¸ã‚§ãƒãƒ³ãƒ‰ãƒ«ï¼‰ã‚’ç›´æ¥ãƒ‰ãƒ©ãƒƒã‚° â†’ recalcã›ãšç›´æ¥ç§»å‹•
      ctrls[info.idx].cx=nx;ctrls[info.idx].cy=ny;
    }else if(info.sub==='s'&&info.idx===0){
      ctrls[0].sx=nx;ctrls[0].sy=ny;
      recalcControlPoints(ctrls);
    }else if(info.sub==='e'){
      const ci=info.idx;
      ctrls[ci].ex=nx;ctrls[ci].ey=ny;
      if(ci<ctrls.length-1){
        ctrls[ci+1].sx=nx;ctrls[ci+1].sy=ny;
      }
      recalcControlPoints(ctrls);
    }
  }else if(info.type==='line'){
    if(info.sub==='s'){s.x1=nx;s.y1=ny;}else{s.x2=nx;s.y2=ny;}
  }else if(info.type==='ellipse'){
    if(info.sub==='center'){s.cx=nx;s.cy=ny;}
    else if(info.sub==='rx'){s.rx=Math.max(1,Math.abs(nx-s.cx));}
    else if(info.sub==='ry'){s.ry=Math.max(1,Math.abs(ny-s.cy));}
  }else if(info.type==='rect'){
    if(info.sub==='tl'){const dx=nx-s.x,dy=ny-s.y;s.x=nx;s.y=ny;s.w-=dx;s.h-=dy;}
    else if(info.sub==='tr'){s.w=nx-s.x;const dy=ny-s.y;s.y=ny;s.h-=dy;}
    else if(info.sub==='br'){s.w=nx-s.x;s.h=ny-s.y;}
    else if(info.sub==='bl'){const dx=nx-s.x;s.x=nx;s.w-=dx;s.h=ny-s.y;}
  }
}
// Catmull-Romã§å…¨åˆ¶å¾¡ç‚¹ã‚’å†è¨ˆç®—ï¼ˆé€šéç‚¹ã®ä½ç½®ã‹ã‚‰æ»‘ã‚‰ã‹ãªåˆ¶å¾¡ç‚¹ã‚’ç”Ÿæˆï¼‰
function recalcControlPoints(ctrls){
  if(!ctrls||ctrls.length===0)return;
  // é€šéç‚¹ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ï¼‰ã‚’åé›†
  const pts=[{x:ctrls[0].sx,y:ctrls[0].sy}];
  for(let i=0;i<ctrls.length;i++)pts.push({x:ctrls[i].ex,y:ctrls[i].ey});
  // å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®åˆ¶å¾¡ç‚¹ã‚’Catmull-Romã§è¨ˆç®—
  for(let i=0;i<ctrls.length;i++){
    const p0=pts[Math.max(0,i-1)];
    const p1=pts[i];       // å§‹ç‚¹
    const p2=pts[i+1];     // çµ‚ç‚¹
    const p3=pts[Math.min(pts.length-1,i+2)];
    // Catmull-Rom â†’ cubic bezier control points
    const cp1x=p1.x+(p2.x-p0.x)/6;
    const cp1y=p1.y+(p2.y-p0.y)/6;
    const cp2x=p2.x-(p3.x-p1.x)/6;
    const cp2y=p2.y-(p3.y-p1.y)/6;
    // quadraticè¿‘ä¼¼ï¼š2ã¤ã®cubicåˆ¶å¾¡ç‚¹ã®ä¸­ç‚¹
    ctrls[i].cx=(cp1x+cp2x)/2;
    ctrls[i].cy=(cp1y+cp2y)/2;
  }
}

function onDownPoint(p,e){
  const fr=CF()[S.layer].frames[S.frame];if(!fr)return;
  const hitR=POINT_RADIUS/S.zoom+3;

  // è¡¨ç¤ºä¸­ã®ãƒ™ã‚¸ã‚§ãƒãƒ³ãƒ‰ãƒ«ï¼ˆåˆ¶å¾¡ç‚¹ï¼‰ã¸ã®ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’æœ€å„ªå…ˆ
  if(selectedStrokeIdx>=0&&selectedPointInfo){
    const handlePts=getVisibleHandlePoints(fr.strokes,selectedStrokeIdx,selectedPointInfo);
    const hHit=findNearestPoint(handlePts,p,hitR);
    if(hHit){pushUndo();dragPointInfo=hHit;renderAll();return;}
  }

  // é¸æŠä¸­ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®é€šéç‚¹
  const selPts=selectedStrokeIdx>=0?getStrokePathPoints(fr.strokes,selectedStrokeIdx):[];
  let hit=findNearestPoint(selPts,p,hitR);
  if(!hit){
    const allPts=getStrokePathPoints(fr.strokes,-1);
    hit=findNearestPoint(allPts,p,hitR);
  }
  if(hit){
    pushUndo();dragPointInfo=hit;selectedStrokeIdx=hit.strokeIdx;
    // é€šéç‚¹ã‚’é¸æŠ â†’ ãƒãƒ³ãƒ‰ãƒ«è¡¨ç¤ºç”¨ã«ä¿æŒ
    if(hit.sub!=='c')selectedPointInfo=hit;
    renderAll();return;
  }
  // ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯æœ¬ä½“ã¸ã®ãƒ’ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
  const si=hitTestStroke(fr.strokes,p,8/S.zoom);
  selectedStrokeIdx=(si>=0)?si:-1;
  dragPointInfo=null;selectedPointInfo=null;
  renderAll();
}

function onMovePoint(p,e){
  if(!dragPointInfo)return;
  const fr=CF()[S.layer].frames[S.frame];if(!fr)return;
  movePathPoint(fr.strokes,dragPointInfo,p.x,p.y);
  renderAll();
}

function onUpPoint(p,e){dragPointInfo=null;}

// é¸æŠä¸­ãƒã‚¤ãƒ³ãƒˆã®å‰å¾Œã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®åˆ¶å¾¡ç‚¹ï¼ˆãƒ™ã‚¸ã‚§ãƒãƒ³ãƒ‰ãƒ«ï¼‰ã‚’å–å¾—
function getVisibleHandlePoints(strokes,si,activePoint){
  const pts=[];
  if(!activePoint||si<0||si>=strokes.length)return pts;
  const s=strokes[si];
  if(s.type!=='bezier'||!s.controls)return pts;
  const ctrls=s.controls;
  const added=new Set();
  const addSeg=(idx)=>{
    if(idx>=0&&idx<ctrls.length&&!added.has(idx)){
      added.add(idx);
      pts.push({x:ctrls[idx].cx,y:ctrls[idx].cy,strokeIdx:si,type:'bezier',idx,sub:'c'});
    }
  };
  if(activePoint.sub==='s'&&activePoint.idx===0){
    // å§‹ç‚¹ â†’ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ0ã®åˆ¶å¾¡ç‚¹
    addSeg(0);
  }else if(activePoint.sub==='e'){
    const ci=activePoint.idx;
    // ã“ã®çµ‚ç‚¹ãŒå±ã™ã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
    addSeg(ci);
    // ã“ã®çµ‚ç‚¹ï¼æ¬¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å§‹ç‚¹ãªã®ã§æ¬¡ã‚‚
    addSeg(ci+1);
  }else if(activePoint.sub==='c'){
    addSeg(activePoint.idx);
  }
  return pts;
}

// ãƒã‚¤ãƒ³ãƒˆç·¨é›†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æç”»
function renderPointEditOverlay(){
  pointEditCtx.clearRect(0,0,S.cw,S.ch);
  if(S.tool!=='point'&&S.tool!=='stroke'){pointEditCanvas.style.display='none';return;}
  pointEditCanvas.style.display='block';
  if(S.tool!=='point')return;
  const fr=CF()[S.layer].frames[S.frame];if(!fr)return;
  const ctx=pointEditCtx;
  const r=POINT_RADIUS;

  // é¸æŠã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®ãƒ‘ã‚¹å¼·èª¿
  if(selectedStrokeIdx>=0&&selectedStrokeIdx<fr.strokes.length){
    const s=fr.strokes[selectedStrokeIdx];
    ctx.save();ctx.strokeStyle='rgba(78,205,196,0.5)';ctx.lineWidth=Math.max(s.size||2,4);ctx.lineCap='round';ctx.lineJoin='round';
    if((s.type==='bezier'||s.type==='eraser')&&s.controls&&s.controls.length>0){
      ctx.beginPath();ctx.moveTo(s.controls[0].sx,s.controls[0].sy);
      for(const c of s.controls)ctx.quadraticCurveTo(c.cx,c.cy,c.ex,c.ey);ctx.stroke();
    }
    ctx.restore();
  }

  // é¸æŠãƒã‚¤ãƒ³ãƒˆå‰å¾Œã®ãƒ™ã‚¸ã‚§ãƒãƒ³ãƒ‰ãƒ«æç”»
  const activeP=selectedPointInfo||dragPointInfo;
  if(activeP&&selectedStrokeIdx>=0&&selectedStrokeIdx<fr.strokes.length){
    const s=fr.strokes[selectedStrokeIdx];
    if((s.type==='bezier'||s.type==='eraser')&&s.controls){
      const handles=getVisibleHandlePoints(fr.strokes,selectedStrokeIdx,activeP);
      for(const h of handles){
        const c=s.controls[h.idx];
        // æ¥ç·šï¼ˆå§‹ç‚¹â†’åˆ¶å¾¡ç‚¹â†’çµ‚ç‚¹ï¼‰
        ctx.save();ctx.strokeStyle='rgba(78,205,196,0.3)';ctx.lineWidth=1;
        ctx.beginPath();ctx.moveTo(c.sx,c.sy);ctx.lineTo(c.cx,c.cy);ctx.lineTo(c.ex,c.ey);ctx.stroke();
        // åˆ¶å¾¡ç‚¹ï¼ˆãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰å‹ï¼‰
        const isActive=(dragPointInfo&&dragPointInfo.sub==='c'&&dragPointInfo.idx===h.idx);
        if(isActive){ctx.fillStyle='#fff';ctx.strokeStyle='#e94560';ctx.lineWidth=2.5;}
        else{ctx.fillStyle='rgba(78,205,196,0.7)';ctx.strokeStyle='rgba(78,205,196,0.9)';ctx.lineWidth=1.5;}
        ctx.beginPath();ctx.moveTo(h.x,h.y-r);ctx.lineTo(h.x+r,h.y);ctx.lineTo(h.x,h.y+r);ctx.lineTo(h.x-r,h.y);ctx.closePath();ctx.fill();ctx.stroke();
        ctx.restore();
      }
    }
  }

  // é€šéç‚¹æç”»
  const pts=(selectedStrokeIdx>=0)?getStrokePathPoints(fr.strokes,selectedStrokeIdx):getStrokePathPoints(fr.strokes,-1);
  for(const pt of pts){
    ctx.save();
    const isDragging=(dragPointInfo&&dragPointInfo.strokeIdx===pt.strokeIdx&&dragPointInfo.idx===pt.idx&&dragPointInfo.sub===pt.sub);
    const isSelected=(!isDragging&&selectedPointInfo&&selectedPointInfo.strokeIdx===pt.strokeIdx&&selectedPointInfo.idx===pt.idx&&selectedPointInfo.sub===pt.sub);
    if(isDragging||isSelected){ctx.fillStyle='#fff';ctx.strokeStyle='#e94560';ctx.lineWidth=2.5;}
    else{ctx.fillStyle='rgba(233,69,96,0.8)';ctx.strokeStyle='#fff';ctx.lineWidth=1.5;}
    ctx.beginPath();ctx.arc(pt.x,pt.y,r,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.restore();
  }
}

// ===========================================================
// ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç·¨é›†ãƒ„ãƒ¼ãƒ«ï¼ˆé¸æŠâ†’ç§»å‹•/æ‹¡ç¸®/å›è»¢ï¼‰
// ===========================================================
function getStrokeBBox(s){
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  const expand=(x,y)=>{if(x<minX)minX=x;if(x>maxX)maxX=x;if(y<minY)minY=y;if(y>maxY)maxY=y;};
  if(s.type==='bezier'||s.type==='eraser'){
    if(!s.controls)return null;
    for(const c of s.controls){expand(c.sx,c.sy);expand(c.cx,c.cy);expand(c.ex,c.ey);}
  }else if(s.type==='line'){expand(s.x1,s.y1);expand(s.x2,s.y2);}
  else if(s.type==='ellipse'){expand(s.cx-s.rx,s.cy-s.ry);expand(s.cx+s.rx,s.cy+s.ry);}
  else if(s.type==='rect'){expand(s.x,s.y);expand(s.x+s.w,s.y+s.h);}
  if(minX===Infinity)return null;
  const pad=4;
  return{x:minX-pad,y:minY-pad,w:maxX-minX+pad*2,h:maxY-minY+pad*2,cx:(minX+maxX)/2,cy:(minY+maxY)/2};
}

// BBoxã‹ã‚‰4é ‚ç‚¹ã‚’ç”Ÿæˆ
function bboxToCorners(bb){
  return[
    {x:bb.x,y:bb.y},           // tl
    {x:bb.x+bb.w,y:bb.y},      // tr
    {x:bb.x+bb.w,y:bb.y+bb.h}, // br
    {x:bb.x,y:bb.y+bb.h}       // bl
  ];
}
function cornersCenter(c){
  return{x:(c[0].x+c[1].x+c[2].x+c[3].x)/4,y:(c[0].y+c[1].y+c[2].y+c[3].y)/4};
}
// å›è»¢ãƒãƒ³ãƒ‰ãƒ«ä½ç½®ï¼ˆä¸Šè¾ºä¸­å¤®ã‹ã‚‰20pxå¤–å´ï¼‰
function getRotateHandle(corners){
  const mx=(corners[0].x+corners[1].x)/2,my=(corners[0].y+corners[1].y)/2;
  const cx=(corners[0].x+corners[2].x)/2,cy=(corners[0].y+corners[2].y)/2;
  const dx=mx-cx,dy=my-cy;
  const len=Math.hypot(dx,dy)||1;
  return{x:mx+dx/len*20,y:my+dy/len*20};
}
// ç‚¹ãŒå›è»¢ã—ãŸå››è§’å½¢ã®å†…éƒ¨ã«ã‚ã‚‹ã‹
function pointInQuad(p,c){
  // cross product sign check
  const cross=(ax,ay,bx,by)=>ax*by-ay*bx;
  for(let i=0;i<4;i++){
    const j=(i+1)%4;
    const ex=c[j].x-c[i].x,ey=c[j].y-c[i].y;
    const fx=p.x-c[i].x,fy=p.y-c[i].y;
    if(cross(ex,ey,fx,fy)<0)return false;
  }
  return true;
}

// ãƒãƒ³ãƒ‰ãƒ«åˆ¤å®šï¼ˆå›è»¢å¯¾å¿œï¼‰
function hitBBoxHandle(corners,center,p,threshold){
  if(!corners)return null;
  // å›è»¢ãƒãƒ³ãƒ‰ãƒ«
  const rh=getRotateHandle(corners);
  if(Math.hypot(p.x-rh.x,p.y-rh.y)<threshold)return 'rotate';
  // è§’ãƒãƒ³ãƒ‰ãƒ«
  const names=['tl','tr','br','bl'];
  for(let i=0;i<4;i++){
    if(Math.hypot(p.x-corners[i].x,p.y-corners[i].y)<threshold)return names[i];
  }
  // æœ¬ä½“å†…éƒ¨
  if(pointInQuad(p,corners))return 'body';
  return null;
}

function transformStroke(s,cx,cy,dx,dy,sx,sy,angle){
  const cosA=Math.cos(angle),sinA=Math.sin(angle);
  const tr=(ox,oy)=>{
    let x=ox-cx,y=oy-cy;
    x*=sx;y*=sy;
    const rx=x*cosA-y*sinA,ry=x*sinA+y*cosA;
    return{x:rx+cx+dx,y:ry+cy+dy};
  };
  if(s.type==='bezier'||s.type==='eraser'){
    if(!s.controls)return;
    for(const c of s.controls){
      const ns=tr(c.sx,c.sy);c.sx=ns.x;c.sy=ns.y;
      const nc=tr(c.cx,c.cy);c.cx=nc.x;c.cy=nc.y;
      const ne=tr(c.ex,c.ey);c.ex=ne.x;c.ey=ne.y;
    }
  }else if(s.type==='line'){
    const a=tr(s.x1,s.y1),b=tr(s.x2,s.y2);
    s.x1=a.x;s.y1=a.y;s.x2=b.x;s.y2=b.y;
  }else if(s.type==='ellipse'){
    const ct=tr(s.cx,s.cy);s.cx=ct.x;s.cy=ct.y;
    s.rx=Math.max(1,s.rx*sx);s.ry=Math.max(1,s.ry*sy);
  }else if(s.type==='rect'){
    const a=tr(s.x,s.y),b=tr(s.x+s.w,s.y+s.h);
    s.x=Math.min(a.x,b.x);s.y=Math.min(a.y,b.y);
    s.w=Math.abs(b.x-a.x);s.h=Math.abs(b.y-a.y);
  }
}

// é ‚ç‚¹é…åˆ—ã‚’åŒã˜å¤‰æ›ã§å‹•ã‹ã™
function transformCorners(corners,cx,cy,dx,dy,sx,sy,angle){
  const cosA=Math.cos(angle),sinA=Math.sin(angle);
  return corners.map(pt=>{
    let x=pt.x-cx,y=pt.y-cy;
    x*=sx;y*=sy;
    const rx=x*cosA-y*sinA,ry=x*sinA+y*cosA;
    return{x:rx+cx+dx,y:ry+cy+dy};
  });
}

function initStrokeEditBox(si,strokes){
  const bb=getStrokeBBox(strokes[si]);
  if(!bb)return;
  strokeEditCorners=bboxToCorners(bb);
  strokeEditCenter=cornersCenter(strokeEditCorners);
}

function onDownStroke(p,e){
  const fr=CF()[S.layer].frames[S.frame];if(!fr)return;
  const hitR=8/S.zoom;
  // æ—¢ã«é¸æŠä¸­ãªã‚‰ãƒãƒ³ãƒ‰ãƒ«åˆ¤å®š
  if(strokeEditIdx>=0&&strokeEditCorners){
    const h=hitBBoxHandle(strokeEditCorners,strokeEditCenter,p,hitR);
    if(h){
      pushUndo();
      strokeEditStart={x:p.x,y:p.y};
      if(h==='body'){strokeEditMode='move';}
      else if(h==='rotate'){
        strokeEditMode='rotate';
        const ax=strokeEditAnchor?strokeEditAnchor.x:strokeEditCenter.x;
        const ay=strokeEditAnchor?strokeEditAnchor.y:strokeEditCenter.y;
        strokeEditInitAngle=Math.atan2(p.y-ay,p.x-ax);
      }else{
        strokeEditMode='scale';
        strokeEditInitScale=Math.hypot(p.x-strokeEditCenter.x,p.y-strokeEditCenter.y);
      }
      return;
    }
  }
  // ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯é¸æŠï¼ˆã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’ã‚¢ãƒ³ã‚«ãƒ¼ã¨ã—ã¦è¨˜éŒ²ï¼‰
  const si=hitTestStroke(fr.strokes,p,hitR);
  if(si>=0){
    strokeEditIdx=si;
    initStrokeEditBox(si,fr.strokes);
    strokeEditAnchor={x:p.x,y:p.y};
    strokeEditMode='';
  }else{
    strokeEditIdx=-1;strokeEditCorners=null;strokeEditCenter=null;strokeEditAnchor=null;strokeEditMode='';
  }
  renderAll();
}

function onMoveStroke(p,e){
  if(strokeEditIdx<0||!strokeEditStart||!strokeEditMode)return;
  const fr=CF()[S.layer].frames[S.frame];if(!fr)return;
  const s=fr.strokes[strokeEditIdx];

  if(strokeEditMode==='move'){
    const dx=p.x-strokeEditStart.x,dy=p.y-strokeEditStart.y;
    offsetStroke(s,dx,dy);
    // ãƒœãƒƒã‚¯ã‚¹ã¨ã‚¢ãƒ³ã‚«ãƒ¼ã‚‚ä¸€ç·’ã«ç§»å‹•
    strokeEditCorners=strokeEditCorners.map(c=>({x:c.x+dx,y:c.y+dy}));
    strokeEditCenter={x:strokeEditCenter.x+dx,y:strokeEditCenter.y+dy};
    if(strokeEditAnchor)strokeEditAnchor={x:strokeEditAnchor.x+dx,y:strokeEditAnchor.y+dy};
    strokeEditStart={x:p.x,y:p.y};
  }else if(strokeEditMode==='scale'){
    const dist=Math.hypot(p.x-strokeEditCenter.x,p.y-strokeEditCenter.y);
    const scale=dist/Math.max(1,strokeEditInitScale);
    const cx=strokeEditCenter.x,cy=strokeEditCenter.y;
    transformStroke(s,cx,cy,0,0,scale,scale,0);
    strokeEditCorners=transformCorners(strokeEditCorners,cx,cy,0,0,scale,scale,0);
    strokeEditCenter=cornersCenter(strokeEditCorners);
    if(strokeEditAnchor){
      const ax=strokeEditAnchor.x,ay=strokeEditAnchor.y;
      strokeEditAnchor={x:cx+(ax-cx)*scale,y:cy+(ay-cy)*scale};
    }
    strokeEditInitScale=dist;
  }else if(strokeEditMode==='rotate'){
    const ax=strokeEditAnchor?strokeEditAnchor.x:strokeEditCenter.x;
    const ay=strokeEditAnchor?strokeEditAnchor.y:strokeEditCenter.y;
    const angle=Math.atan2(p.y-ay,p.x-ax);
    const da=angle-strokeEditInitAngle;
    transformStroke(s,ax,ay,0,0,1,1,da);
    strokeEditCorners=transformCorners(strokeEditCorners,ax,ay,0,0,1,1,da);
    strokeEditCenter=cornersCenter(strokeEditCorners);
    strokeEditInitAngle=angle;
  }
  renderAll();
}

function onUpStroke(p,e){
  strokeEditMode='';strokeEditStart=null;
}

// ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ç·¨é›†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æç”»ï¼ˆå›è»¢å¯¾å¿œãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹+ãƒãƒ³ãƒ‰ãƒ«ï¼‰
function renderStrokeEditOverlay(){
  if(S.tool!=='stroke'||strokeEditIdx<0||!strokeEditCorners)return;
  const ctx=pointEditCtx;
  const c=strokeEditCorners;
  const r=5;

  ctx.save();
  // å›è»¢å¯¾å¿œãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ï¼ˆå››è§’å½¢ãƒ‘ã‚¹ï¼‰
  ctx.strokeStyle='rgba(78,205,196,0.8)';ctx.lineWidth=1.5;ctx.setLineDash([6,3]);
  ctx.beginPath();
  ctx.moveTo(c[0].x,c[0].y);ctx.lineTo(c[1].x,c[1].y);ctx.lineTo(c[2].x,c[2].y);ctx.lineTo(c[3].x,c[3].y);ctx.closePath();
  ctx.stroke();ctx.setLineDash([]);

  // å›è»¢ãƒãƒ³ãƒ‰ãƒ«ã¸ã®ç·š
  const rh=getRotateHandle(c);
  ctx.strokeStyle='rgba(78,205,196,0.4)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo((c[0].x+c[1].x)/2,(c[0].y+c[1].y)/2);ctx.lineTo(rh.x,rh.y);ctx.stroke();

  // å›è»¢ãƒãƒ³ãƒ‰ãƒ«ï¼ˆç´«ä¸¸ï¼‰
  ctx.fillStyle='rgba(168,85,247,0.8)';ctx.strokeStyle='#fff';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(rh.x,rh.y,r,0,Math.PI*2);ctx.fill();ctx.stroke();

  // è§’ãƒãƒ³ãƒ‰ãƒ«ï¼ˆå››è§’ï¼‰
  ctx.fillStyle='rgba(78,205,196,0.8)';ctx.strokeStyle='#fff';ctx.lineWidth=1.5;
  for(let i=0;i<4;i++){
    ctx.beginPath();ctx.rect(c[i].x-r,c[i].y-r,r*2,r*2);ctx.fill();ctx.stroke();
  }

  // ã‚¢ãƒ³ã‚«ãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆå›è»¢è»¸ï¼‰è¡¨ç¤º
  if(strokeEditAnchor){
    const ax=strokeEditAnchor.x,ay=strokeEditAnchor.y;
    ctx.strokeStyle='rgba(233,69,96,0.9)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(ax-6,ay);ctx.lineTo(ax+6,ay);ctx.stroke();
    ctx.beginPath();ctx.moveTo(ax,ay-6);ctx.lineTo(ax,ay+6);ctx.stroke();
    ctx.beginPath();ctx.arc(ax,ay,4,0,Math.PI*2);ctx.strokeStyle='rgba(233,69,96,0.7)';ctx.stroke();
  }
  ctx.restore();
}

// ===========================================================
// å…¨ä½“ç§»å‹•ãƒ„ãƒ¼ãƒ«
// ===========================================================
function onDownMove(p,e){
  const fr=CF()[S.layer].frames[S.frame];if(!fr||fr.strokes.length===0)return;
  pushUndo();
  moveDragging=true;moveMode='all';moveDragStart={x:p.x,y:p.y};
}

function onMoveMove(p,e){
  if(!moveDragging||!moveDragStart)return;
  const dx=p.x-moveDragStart.x,dy=p.y-moveDragStart.y;
  const fr=CF()[S.layer].frames[S.frame];if(!fr)return;
  for(const s of fr.strokes)offsetStroke(s,dx,dy);
  moveDragStart={x:p.x,y:p.y};
  renderAll();
}

function onUpMove(p,e){
  moveDragging=false;moveDragStart=null;
}

function offsetStroke(s,dx,dy){
  if(s.type==='bezier'||s.type==='eraser'){
    if(!s.controls)return;
    for(const c of s.controls){c.sx+=dx;c.sy+=dy;c.cx+=dx;c.cy+=dy;c.ex+=dx;c.ey+=dy;}
  }else if(s.type==='line'){
    s.x1+=dx;s.y1+=dy;s.x2+=dx;s.y2+=dy;
  }else if(s.type==='ellipse'){
    s.cx+=dx;s.cy+=dy;
  }else if(s.type==='rect'){
    s.x+=dx;s.y+=dy;
  }
}

// ===========================================================
// ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆæ•°èª¿æ•´ï¼ˆãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰
// ===========================================================
// ãƒ™ã‚¸ã‚§æ›²ç·šã‚’tå€¤ã§è©•ä¾¡ã—ã¦é€šéç‚¹åˆ—ã‚’å¾—ã‚‹
function sampleBezierPath(controls,numSamples){
  if(!controls||controls.length===0)return[];
  const pts=[];
  const totalSegs=controls.length;
  for(let i=0;i<numSamples;i++){
    const globalT=i/(numSamples-1)*totalSegs;
    const segIdx=Math.min(Math.floor(globalT),totalSegs-1);
    const localT=globalT-segIdx;
    const c=controls[segIdx];
    const t=localT,mt=1-t;
    pts.push({x:mt*mt*c.sx+2*mt*t*c.cx+t*t*c.ex,y:mt*mt*c.sy+2*mt*t*c.cy+t*t*c.ey});
  }
  return pts;
}
// é€šéç‚¹åˆ—ã‹ã‚‰ãƒ™ã‚¸ã‚§åˆ¶å¾¡ç‚¹åˆ—ã‚’å†æ§‹ç¯‰ï¼ˆCatmull-Româ†’ãƒ™ã‚¸ã‚§å¤‰æ›ï¼‰
function fitBezierToPoints(pts){
  if(pts.length<2)return[];
  const controls=[];
  for(let i=0;i<pts.length-1;i++){
    const p0=pts[Math.max(0,i-1)];
    const p1=pts[i];
    const p2=pts[i+1];
    const p3=pts[Math.min(pts.length-1,i+2)];
    // Catmull-Rom to cubic bezier, then cubicâ†’quadratic approximation
    const cx1=p1.x+(p2.x-p0.x)/6;
    const cy1=p1.y+(p2.y-p0.y)/6;
    const cx2=p2.x-(p3.x-p1.x)/6;
    const cy2=p2.y-(p3.y-p1.y)/6;
    // quadratic control point = midpoint of cubic control points
    const qcx=(cx1+cx2)/2;
    const qcy=(cy1+cy2)/2;
    controls.push({sx:p1.x,sy:p1.y,cx:qcx,cy:qcy,ex:p2.x,ey:p2.y});
  }
  return controls;
}
// ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
function resampleStrokePoints(s,newCount){
  if(s.type!=='bezier'||!s.controls||s.controls.length===0)return;
  // å…ƒã®æ›²ç·šä¸Šã®é€šéç‚¹ã‚’å¤šã‚ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
  const denseSamples=sampleBezierPath(s.controls,Math.max(200,newCount*10));
  // ç­‰è·é›¢ã§é–“å¼•ã„ã¦newCountå€‹ã®é€šéç‚¹ã‚’å¾—ã‚‹
  const totalLen=[];let len=0;totalLen.push(0);
  for(let i=1;i<denseSamples.length;i++){
    len+=Math.hypot(denseSamples[i].x-denseSamples[i-1].x,denseSamples[i].y-denseSamples[i-1].y);
    totalLen.push(len);
  }
  const step=len/(newCount);
  const keyPts=[denseSamples[0]];
  let nextDist=step;
  for(let i=1;i<denseSamples.length;i++){
    if(totalLen[i]>=nextDist){
      keyPts.push(denseSamples[i]);
      nextDist+=step;
    }
  }
  // å¿…ãšçµ‚ç‚¹ã‚’å«ã‚ã‚‹
  const last=denseSamples[denseSamples.length-1];
  if(keyPts.length>0&&Math.hypot(keyPts[keyPts.length-1].x-last.x,keyPts[keyPts.length-1].y-last.y)>0.5){
    keyPts.push(last);
  }
  if(keyPts.length<2)return;
  s.controls=fitBezierToPoints(keyPts);
}
// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¡¨ç¤ºæ›´æ–°
function getSelectedStrokeForSlider(){
  const fr=CF()[S.layer].frames[S.frame];if(!fr)return null;
  let idx=-1;
  if(S.tool==='stroke'&&strokeEditIdx>=0)idx=strokeEditIdx;
  else if(S.tool==='point'&&selectedStrokeIdx>=0)idx=selectedStrokeIdx;
  if(idx<0||idx>=fr.strokes.length)return null;
  const s=fr.strokes[idx];
  if(s.type!=='bezier'||!s.controls)return null;
  return s;
}
function updateStrokePointSlider(){
  const slider=document.getElementById('stroke-point-slider');
  const val=document.getElementById('stroke-point-val');
  const s=getSelectedStrokeForSlider();
  if(!s){val.textContent='-';slider.value=10;slider.disabled=true;return;}
  const n=s.controls.length+1; // é€šéç‚¹ã®æ•°=ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°+1
  val.textContent=n;
  slider.value=n;
  slider.min=2;
  slider.max=Math.max(n*3,100);
  slider.disabled=false;
}
let _strokePointSliderBak=null; // undoç”¨ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
function onStrokePointSliderInput(e){
  const s=getSelectedStrokeForSlider();if(!s)return;
  const newPts=+e.target.value;
  if(newPts<2)return;
  // åˆå›ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã«undoãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  if(!_strokePointSliderBak){
    pushUndo();
    _strokePointSliderBak=JSON.parse(JSON.stringify(s.controls));
  }
  // å…ƒã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆç´¯ç©åŠ£åŒ–é˜²æ­¢ï¼‰
  const tmpS={type:'bezier',controls:JSON.parse(JSON.stringify(_strokePointSliderBak))};
  resampleStrokePoints(tmpS,newPts);
  s.controls=tmpS.controls;
  document.getElementById('stroke-point-val').textContent=s.controls.length+1;
  renderAll();
}
// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼é›¢ã—ãŸæ™‚ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢
document.addEventListener('mouseup',()=>{_strokePointSliderBak=null;});

// ===========================================================
// ã‚ªãƒ‹ã‚ªãƒ³ã‚¹ã‚­ãƒ³
// ===========================================================
function renderOnion(){
  onionCtx.clearRect(0,0,S.cw,S.ch);
  if(!document.getElementById('onion-enabled').checked){onionCanvas.style.display='none';return;}
  onionCanvas.style.display='block';
  const pv=+document.getElementById('onion-prev').value||0,nx=+document.getElementById('onion-next').value||0;
  for(let d=1;d<=pv;d++){const fi=S.frame-d;if(fi<0)continue;drawOnionFrame(fi,`rgba(233,69,96,${0.25/d})`);}
  for(let d=1;d<=nx;d++){const fi=S.frame+d;if(fi>=CTF())continue;drawOnionFrame(fi,`rgba(78,205,196,${0.25/d})`);}
}
function drawOnionFrame(fi,col){for(let li=0;li<4;li++){if(!layerVis[li])continue;const fr=getEffectiveFrame(li,fi);if(!fr)continue;for(const s of fr.strokes){if(s.type==='eraser')continue;drawStroke(onionCtx,{...s,color:col});}}}
function toggleOnionSkin(){const cb=document.getElementById('onion-enabled');cb.checked=!cb.checked;renderAll();}

// ===========================================================
// æ›¸ãé †ã‚¬ã‚¤ãƒ‰ï¼ˆCACANIé¢¨ - å‰ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
// ===========================================================
function renderStrokeGuide(){
  guideCtx.clearRect(0,0,S.cw,S.ch);
  if(!document.getElementById('stroke-guide-enabled').checked){guideCanvas.style.display='none';return;}
  guideCanvas.style.display='block';
  const prevFi=S.frame-1;if(prevFi<0)return;
  for(let li=0;li<4;li++){if(!layerVis[li])continue;const fr=getEffectiveFrame(li,prevFi);if(!fr)continue;
    const strokes=[...fr.strokes].filter(s=>s.type!=='eraser').sort((a,b)=>a.order-b.order);
    for(let idx=0;idx<strokes.length;idx++)drawStrokeGuideAnnotation(guideCtx,strokes[idx],idx+1);
  }
}
function drawStrokeGuideAnnotation(ctx,s,num){
  let sx,sy,ex,ey;
  if(s.type==='bezier'&&s.controls&&s.controls.length>0){const f=s.controls[0],l=s.controls[s.controls.length-1];sx=f.sx;sy=f.sy;ex=l.ex;ey=l.ey;}
  else if(s.type==='line'){sx=s.x1;sy=s.y1;ex=s.x2;ey=s.y2;}
  else if(s.type==='ellipse'){sx=s.cx+s.rx;sy=s.cy;ex=s.cx;ey=s.cy-s.ry;}
  else if(s.type==='rect'){sx=s.x;sy=s.y;ex=s.x+s.w;ey=s.y;}else return;
  ctx.save();ctx.fillStyle='rgba(233,69,96,0.85)';ctx.beginPath();ctx.arc(sx,sy-14,9,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 10px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(String(num),sx,sy-14);ctx.restore();
  const dx=ex-sx,dy=ey-sy,dist=Math.hypot(dx,dy);if(dist<5)return;
  const arrowLen=Math.min(40,dist*0.6),nx=dx/dist,ny=dy/dist,ax=sx+nx*arrowLen,ay=sy+ny*arrowLen;
  ctx.save();ctx.strokeStyle='rgba(233,69,96,0.7)';ctx.lineWidth=2;ctx.lineCap='round';
  ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(ax,ay);ctx.stroke();
  const hl=8,angle=Math.atan2(ay-sy,ax-sx);
  ctx.beginPath();ctx.moveTo(ax,ay);ctx.lineTo(ax-hl*Math.cos(angle-0.4),ay-hl*Math.sin(angle-0.4));ctx.moveTo(ax,ay);ctx.lineTo(ax-hl*Math.cos(angle+0.4),ay-hl*Math.sin(angle+0.4));ctx.stroke();ctx.restore();
}
function toggleStrokeGuide(){const cb=document.getElementById('stroke-guide-enabled');cb.checked=!cb.checked;renderAll();}

// ===========================================================
// ã‚«ãƒƒãƒˆç®¡ç†
// ===========================================================
function updateCutList(){
  const list=document.getElementById('cut-list');list.innerHTML='';
  for(let i=0;i<cuts.length;i++){const c=cuts[i];const item=document.createElement('div');item.className='cut-item'+(i===currentCut?' active':'');item.onclick=()=>switchCut(i);
    const lbl=document.createElement('span');lbl.className='cut-label';lbl.textContent=c.name;
    const info=document.createElement('span');info.className='cut-frames';info.textContent=c.totalFrames+'f';
    item.appendChild(lbl);item.appendChild(info);list.appendChild(item);}
  document.getElementById('current-cut-display').textContent=CC().name;
}
function switchCut(idx){currentCut=idx;S.frame=0;updateCutList();updateLayerList();updateTimeline();renderAll();}
function addCut(){const num=cuts.length+1;const name='C_'+String(num).padStart(3,'0');cuts.push(createEmptyCut(name,24));switchCut(cuts.length-1);notify(`ã‚«ãƒƒãƒˆ ${name} ã‚’è¿½åŠ `);}
function removeCut(){if(cuts.length<=1){notify('æœ€å¾Œã®ã‚«ãƒƒãƒˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“');return;}if(!confirm(`${CC().name} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;cuts.splice(currentCut,1);if(currentCut>=cuts.length)currentCut=cuts.length-1;for(let i=0;i<cuts.length;i++)cuts[i].name='C_'+String(i+1).padStart(3,'0');S.frame=0;updateCutList();updateLayerList();updateTimeline();renderAll();notify('ã‚«ãƒƒãƒˆã‚’å‰Šé™¤');}

// ===========================================================
// ãƒ¬ã‚¤ãƒ¤ãƒ¼
// ===========================================================
function updateLayerList(){
  const list=document.getElementById('layer-list');list.innerHTML='';
  for(let i=LAYER_DEFS.length-1;i>=0;i--){const d=LAYER_DEFS[i];const item=document.createElement('div');item.className='layer-item'+(i===S.layer?' active':'');item.onclick=()=>{S.layer=i;updateLayerList();renderAll();};
    const dot=document.createElement('div');dot.className='layer-color-dot';dot.style.background=d.color;
    const nm=document.createElement('div');nm.className='layer-name';nm.textContent=d.name;
    const vis=document.createElement('button');vis.className='layer-vis-btn'+(layerVis[i]?'':' hidden');vis.textContent=layerVis[i]?'ğŸ‘':'ğŸš«';
    vis.onclick=e=>{e.stopPropagation();layerVis[i]=!layerVis[i];updateLayerList();renderAll();};
    item.appendChild(dot);item.appendChild(nm);item.appendChild(vis);list.appendChild(item);}
}
function clearCurrentLayer(){pushUndo();CF()[S.layer].frames[S.frame]={strokes:[],draftImg:null};renderAll();notify('ã‚¯ãƒªã‚¢');}
function duplicateFrame(){pushUndo();const nf=S.frame+1;if(nf<CTF()){CF()[S.layer].frames[nf]=JSON.parse(JSON.stringify(CF()[S.layer].frames[S.frame]));goToFrame(nf);notify('ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¤‡è£½');}}

// ===========================================================
// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
// ===========================================================
function updateTimeline(){
  const tf=CTF();const hd=document.getElementById('tl-header');hd.innerHTML='';
  for(let f=0;f<tf;f++){const d=document.createElement('div');d.className='tl-frame-num'+(f===S.frame?' current':'');d.textContent=f+1;d.onclick=()=>goToFrame(f);hd.appendChild(d);}
  const lb=document.getElementById('tl-layer-labels-inner');lb.innerHTML='';
  for(let i=0;i<LAYER_DEFS.length;i++){const d=document.createElement('div');d.className='tl-layer-label'+(i===S.layer?' active':'');d.onclick=()=>{S.layer=i;updateLayerList();updateTimeline();renderAll();};const dot=document.createElement('span');dot.className='dot';dot.style.background=LAYER_DEFS[i].color;d.appendChild(dot);d.appendChild(document.createTextNode(LAYER_DEFS[i].name));lb.appendChild(d);}
  const rows=document.getElementById('tl-rows');rows.innerHTML='';
  for(let i=0;i<LAYER_DEFS.length;i++){
    const row=document.createElement('div');row.className='tl-row';
    for(let f=0;f<tf;f++){
      const cell=document.createElement('div');cell.className='tl-cell';
      if(f===S.frame)cell.classList.add('current-frame');
      const fr=CF()[i].frames[f];
      const hasData=fr&&(fr.strokes.length>0||fr.draftImg);
      if(hasData)cell.classList.add('has-data');
      const dk=i+'-'+f;const durVal=CFD()[dk]||1;
      if(durVal>1){cell.classList.add('hold-start');cell.title=durVal+'fæŒç¶š';}
      else{
        const eidx=getEffectiveFrameIdx(i,f);
        if(eidx!==f){cell.classList.add('hold-frame');cell.title='â† ãƒ•ãƒ¬ãƒ¼ãƒ '+(eidx+1)+'ã®æŒç¶š';}
      }
      // é¸æŠçŠ¶æ…‹
      if(tlSelected.has(i+'-'+f))cell.classList.add('tl-selected');
      // ãƒ‰ãƒ©ãƒƒã‚°ã‚´ãƒ¼ã‚¹ãƒˆ
      if(tlDragging&&tlDragCurrent!==null){
        const delta=tlDragCurrent-(tlDragSource?tlDragSource.fi:0);
        const selArr=tlGetSelectedOnLayer(i);
        if(selArr.length>0){
          for(const sf of selArr){
            if(f===sf+delta&&f!==sf)cell.classList.add('tl-drag-ghost');
          }
        }else if(tlDragSource&&tlDragSource.li===i&&f===tlDragSource.fi+delta&&f!==tlDragSource.fi){
          cell.classList.add('tl-drag-ghost');
        }
      }
      cell.dataset.li=i;cell.dataset.fi=f;
      cell.addEventListener('mousedown',e=>tlCellMouseDown(e,i,f));
      cell.addEventListener('contextmenu',e=>showCtxMenu(e,i,f));
      row.appendChild(cell);
    }rows.appendChild(row);
  }
  document.getElementById('current-frame-display').textContent=S.frame+1;
  document.getElementById('total-frame-display').textContent=tf;
  document.getElementById('info-frames').value=tf;
  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³é«˜ã•ã‚’å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºã«åˆã‚ã›ã¦å‹•çš„è¨ˆç®—
  updateTimelineHeight();
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸ
  setupTimelineScrollSync();
}
function updateTimelineHeight(){
  // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡Œï¼ˆå®Ÿéš›ã®é«˜ã•ï¼‰+ ãƒ˜ãƒƒãƒ€ãƒ¼(18) + å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œ(24*N) + ä½™ç™½(4)
  const ctrl=document.getElementById('timeline-controls');
  const ctrlH=ctrl?ctrl.offsetHeight:32;
  const h=ctrlH+18+LAYER_DEFS.length*24+4;
  document.getElementById('timeline-panel').style.height=h+'px';
}
function setupTimelineScrollSync(){
  const framesArea=document.getElementById('tl-frames-area');
  const labelsEl=document.getElementById('tl-layer-labels');
  // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸï¼šãƒ•ãƒ¬ãƒ¼ãƒ ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«åˆã‚ã›ã¦ãƒ©ãƒ™ãƒ«ã‚‚å‹•ã
  framesArea.onscroll=()=>{
    labelsEl.scrollTop=framesArea.scrollTop;
  };
}
function goToFrame(f){if(f<0||f>=CTF())return;S.frame=f;updateTimeline();renderAll();}

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ  ãƒ‰ãƒ©ãƒƒã‚°ï¼†é¸æŠ
function tlGetSelectedOnLayer(li){
  const arr=[];
  for(const k of tlSelected){const p=k.split('-');if(+p[0]===li)arr.push(+p[1]);}
  arr.sort((a,b)=>a-b);return arr;
}
function tlCellMouseDown(e,li,fi){
  if(e.button!==0)return;
  e.preventDefault();
  const fr=CF()[li].frames[fi];
  const hasData=fr&&(fr.strokes.length>0||fr.draftImg);
  const durVal=CFD()[li+'-'+fi]||1;
  const isKeyCell=hasData||durVal>1;
  const key=li+'-'+fi;

  if(e.shiftKey){
    // Shift+ã‚¯ãƒªãƒƒã‚¯: é¸æŠãƒˆã‚°ãƒ«ï¼ˆãƒ‡ãƒ¼ã‚¿ã®ã‚ã‚‹ã‚»ãƒ«ã®ã¿ï¼‰
    if(isKeyCell){
      if(tlSelected.has(key))tlSelected.delete(key);
      else tlSelected.add(key);
    }
    S.layer=li;goToFrame(fi);updateLayerList();
    return;
  }

  // é¸æŠã‚»ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹åˆ¤å®š
  if(tlSelected.has(key)||isKeyCell){
    tlDragging=true;
    tlDragSource={li,fi};
    tlDragCurrent=fi;
    // é¸æŠä¸­ã§ãªã„å ´åˆã¯ã“ã®ã‚»ãƒ«å˜ä½“ã‚’ãƒ‰ãƒ©ãƒƒã‚°
    if(!tlSelected.has(key)&&!e.shiftKey){tlSelected.clear();if(isKeyCell)tlSelected.add(key);}

    const onMove=ev=>{
      const cell=document.elementFromPoint(ev.clientX,ev.clientY);
      if(cell&&cell.dataset&&cell.dataset.fi!==undefined){
        const newFi=+cell.dataset.fi;
        if(newFi!==tlDragCurrent){
          tlDragCurrent=newFi;
          updateTimeline();
        }
      }
    };
    const onUp=ev=>{
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
      if(tlDragging&&tlDragCurrent!==null&&tlDragCurrent!==tlDragSource.fi){
        tlApplyDrag();
      }else{
        // ã‚¯ãƒªãƒƒã‚¯ã®ã¿ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ãªã—ï¼‰â†’ ãƒ•ãƒ¬ãƒ¼ãƒ ç§»å‹•
        if(!e.shiftKey)tlSelected.clear();
        S.layer=li;goToFrame(fi);updateLayerList();
      }
      tlDragging=false;tlDragSource=null;tlDragCurrent=null;
      updateTimeline();
    };
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  }else{
    // ç©ºã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯
    if(!e.shiftKey)tlSelected.clear();
    S.layer=li;goToFrame(fi);updateLayerList();
  }
}
function tlApplyDrag(){
  if(!tlDragSource)return;
  const delta=tlDragCurrent-tlDragSource.fi;
  if(delta===0)return;
  pushUndo();

  // å…¨é¸æŠãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ•ãƒ¬ãƒ¼ãƒ ç§»å‹•ã‚’åé›†
  const layerMap={};// li -> [fi1,fi2,...]
  for(const k of tlSelected){
    const p=k.split('-');const li=+p[0],fi=+p[1];
    if(!layerMap[li])layerMap[li]=[];
    layerMap[li].push(fi);
  }

  const tf=CTF();
  for(const liStr in layerMap){
    const li=+liStr;
    const srcFrames=layerMap[li].sort((a,b)=>a-b);
    const frames=CF()[li].frames;
    const dur=CFD();

    // ç§»å‹•å…ˆãŒç¯„å›²å¤–ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
    const minDst=srcFrames[0]+delta,maxDst=srcFrames[srcFrames.length-1]+delta;
    if(minDst<0||maxDst>=tf)continue;

    // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’é€€é¿
    const saved=[];
    for(const fi of srcFrames){
      saved.push({fi,data:JSON.parse(JSON.stringify(frames[fi])),dur:dur[li+'-'+fi]||1});
    }
    // å…ƒä½ç½®ã‚’ã‚¯ãƒªã‚¢
    for(const fi of srcFrames){
      frames[fi]={strokes:[],draftImg:null};
      delete dur[li+'-'+fi];
    }
    // ç§»å‹•å…ˆã«é…ç½®ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã‚¹ãƒ¯ãƒƒãƒ—ï¼‰
    const displaced=[];
    for(const s of saved){
      const dst=s.fi+delta;
      // ç§»å‹•å…ˆãŒä»–ã®é¸æŠã‚»ãƒ«ã®å…ƒä½ç½®ã§ãªã„å ´åˆã€é€€é¿
      if(!srcFrames.includes(dst)){
        displaced.push({fi:dst,data:JSON.parse(JSON.stringify(frames[dst])),dur:dur[li+'-'+dst]||1});
      }
      frames[dst]=s.data;
      if(s.dur>1)dur[li+'-'+dst]=s.dur;else delete dur[li+'-'+dst];
    }
    // é€€é¿ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒä½ç½®ã«é…ç½®
    for(const d of displaced){
      // ç©ºã«ãªã£ãŸå…ƒä½ç½®ã‚’æ¢ã™
      for(const fi of srcFrames){
        const curFr=frames[fi];
        if(curFr&&curFr.strokes.length===0&&!curFr.draftImg){
          frames[fi]=d.data;
          if(d.dur>1)dur[li+'-'+fi]=d.dur;
          break;
        }
      }
    }
  }

  // é¸æŠã‚»ãƒƒãƒˆã‚’ç§»å‹•å…ˆã«æ›´æ–°
  const newSel=new Set();
  for(const k of tlSelected){
    const p=k.split('-');const li=+p[0],fi=+p[1];
    const dst=fi+delta;
    if(dst>=0&&dst<tf)newSel.add(li+'-'+dst);
  }
  tlSelected=newSel;
  goToFrame(Math.max(0,Math.min(tf-1,S.frame+delta)));
}
function goNextFrame(){goToFrame(S.frame+1);}function goPrevFrame(){goToFrame(S.frame-1);}
function goFirstFrame(){goToFrame(0);}function goLastFrame(){goToFrame(CTF()-1);}
function addFrame(){CC().totalFrames++;for(let i=0;i<LAYER_DEFS.length;i++)CF()[i].frames.push({strokes:[],draftImg:null});updateTimeline();}
function removeFrame(){if(CTF()<=1)return;pushUndo();for(let i=0;i<LAYER_DEFS.length;i++)CF()[i].frames.splice(S.frame,1);CC().totalFrames--;if(S.frame>=CTF())S.frame=CTF()-1;updateTimeline();renderAll();}
function insertKeyframe(){pushUndo();const f=S.frame+1;for(let i=0;i<LAYER_DEFS.length;i++)CF()[i].frames.splice(f,0,{strokes:[],draftImg:null});CC().totalFrames++;goToFrame(f);notify('ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æŒ¿å…¥');}
function updateFPS(){S.fps=+document.getElementById('fps-input').value||12;}

// ===========================================================
// å†ç”Ÿ
// ===========================================================
function togglePlay(){S.playing?stopPlay():startPlay();}
function startPlay(){S.playing=true;document.getElementById('play-btn').classList.add('active');document.getElementById('play-btn').textContent='â¸';playNext();}
function stopPlay(){S.playing=false;document.getElementById('play-btn').classList.remove('active');document.getElementById('play-btn').textContent='â–¶';if(S.playTimer){clearTimeout(S.playTimer);S.playTimer=null;}}
function playNext(){
  if(!S.playing)return;
  // å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŒç¶šå€¤ã‚’ç¢ºèªã—ã€æœ€å¤§æŒç¶šã§ã‚¹ã‚­ãƒƒãƒ—
  let skip=1;
  for(let li=0;li<LAYER_DEFS.length;li++){
    const d=CFD()[li+'-'+S.frame]||1;
    if(d>skip)skip=d;
  }
  let nf=S.frame+skip;
  if(nf>=CTF())nf=0;
  goToFrame(nf);
  S.playTimer=setTimeout(playNext,1000/S.fps);
}

// ===========================================================
// è‡ªå‹•ä¸­å‰²
// ===========================================================
function showInbetweenDialog(){document.getElementById('inb-start').value=S.frame+1;document.getElementById('inb-end').value=Math.min(S.frame+2,CTF());document.getElementById('inb-count').value=3;document.getElementById('inbetween-dialog').classList.add('show');}
function generateInbetweens(){
  const sf=+document.getElementById('inb-start').value-1,ef=+document.getElementById('inb-end').value-1,cnt=+document.getElementById('inb-count').value,ease=document.getElementById('inb-easing').value;
  if(sf<0||ef>=CTF()||sf>=ef){notify('ãƒ•ãƒ¬ãƒ¼ãƒ ç¯„å›²ãŒä¸æ­£ã§ã™');return;}pushUndo();
  const sS=CF()[S.layer].frames[sf].strokes,eS=CF()[S.layer].frames[ef].strokes;
  for(let i=0;i<cnt;i++){const t=(i+1)/(cnt+1);const interp=interpStrokes(sS,eS,t,ease);const ins=sf+1+i;for(let li=0;li<LAYER_DEFS.length;li++){CF()[li].frames.splice(ins,0,{strokes:li===S.layer?interp:[],draftImg:null});}CC().totalFrames++;}
  closeModal('inbetween-dialog');updateTimeline();renderAll();notify(`${cnt}æšã®ä¸­å‰²ã‚’ç”Ÿæˆ`);
}
function interpStrokes(sa,sb,t,ease){const et=applyEase(t,ease);const r=[];const mx=Math.max(sa.length,sb.length);for(let i=0;i<mx;i++){const a=i<sa.length?sa[i]:null,b=i<sb.length?sb[i]:null;if(a&&b&&a.type===b.type)r.push(interpOne(a,b,et));else if(a&&!b)r.push(fadeS(a,1-et));else if(!a&&b)r.push(fadeS(b,et));else if(a&&b){et<0.5?r.push(fadeS(a,1-et*2)):r.push(fadeS(b,(et-0.5)*2));}}return r;}
function interpOne(a,b,t){
  if(a.type==='bezier'&&b.type==='bezier')return{type:'bezier',controls:interpBezier(a.controls,b.controls,t),color:lerpCol(a.color,b.color,t),size:lerp(a.size,b.size,t),order:a.order};
  if(a.type==='line'&&b.type==='line')return{type:'line',x1:lerp(a.x1,b.x1,t),y1:lerp(a.y1,b.y1,t),x2:lerp(a.x2,b.x2,t),y2:lerp(a.y2,b.y2,t),color:lerpCol(a.color,b.color,t),size:lerp(a.size,b.size,t),order:a.order};
  if(a.type==='ellipse'&&b.type==='ellipse')return{type:'ellipse',cx:lerp(a.cx,b.cx,t),cy:lerp(a.cy,b.cy,t),rx:lerp(a.rx,b.rx,t),ry:lerp(a.ry,b.ry,t),color:lerpCol(a.color,b.color,t),size:lerp(a.size,b.size,t),order:a.order};
  if(a.type==='rect'&&b.type==='rect')return{type:'rect',x:lerp(a.x,b.x,t),y:lerp(a.y,b.y,t),w:lerp(a.w,b.w,t),h:lerp(a.h,b.h,t),color:lerpCol(a.color,b.color,t),size:lerp(a.size,b.size,t),order:a.order};return a;
}
function interpBezier(ca,cb,t){const ml=Math.max(ca.length,cb.length);const ra=resampleCtrl(ca,ml),rb=resampleCtrl(cb,ml);return ra.map((a,i)=>{const b=rb[i];return{sx:lerp(a.sx,b.sx,t),sy:lerp(a.sy,b.sy,t),cx:lerp(a.cx,b.cx,t),cy:lerp(a.cy,b.cy,t),ex:lerp(a.ex,b.ex,t),ey:lerp(a.ey,b.ey,t)};});}
function resampleCtrl(c,n){if(c.length===n)return c;if(c.length===0)return Array(n).fill({sx:0,sy:0,cx:0,cy:0,ex:0,ey:0});const r=[];for(let i=0;i<n;i++){const si=(i/(n-1||1))*(c.length-1);const lo=Math.floor(si),hi=Math.min(lo+1,c.length-1),f=si-lo;const a=c[lo],b=c[hi];r.push({sx:lerp(a.sx,b.sx,f),sy:lerp(a.sy,b.sy,f),cx:lerp(a.cx,b.cx,f),cy:lerp(a.cy,b.cy,f),ex:lerp(a.ex,b.ex,f),ey:lerp(a.ey,b.ey,f)});}return r;}
function fadeS(s,a){const r=JSON.parse(JSON.stringify(s));if(r.color){const rgb=hex2rgb(r.color);if(rgb)r.color=`rgba(${rgb.r},${rgb.g},${rgb.b},${a})`;}return r;}
function lerp(a,b,t){return a+(b-a)*t;}
function lerpCol(a,b,t){const c1=hex2rgb(a)||{r:0,g:0,b:0},c2=hex2rgb(b)||{r:0,g:0,b:0};return`rgb(${Math.round(lerp(c1.r,c2.r,t))},${Math.round(lerp(c1.g,c2.g,t))},${Math.round(lerp(c1.b,c2.b,t))})`;}
function hex2rgb(h){if(!h)return null;if(h.startsWith('rgb')){const m=h.match(/(\d+)/g);return m?{r:+m[0],g:+m[1],b:+m[2]}:null;}const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null;}
function applyEase(t,ty){switch(ty){case'easeIn':return t*t;case'easeOut':return t*(2-t);case'easeInOut':return t<0.5?2*t*t:-1+(4-2*t)*t;default:return t;}}

// ===========================================================
// Undo/Redo
// ===========================================================
function pushUndo(){undoStack.push({cuts:JSON.parse(JSON.stringify(cuts)),cc:currentCut,f:S.frame,li:S.layer});if(undoStack.length>MAX_UNDO)undoStack.shift();redoStack=[];}
function undoAction(){if(!undoStack.length)return;redoStack.push({cuts:JSON.parse(JSON.stringify(cuts)),cc:currentCut,f:S.frame,li:S.layer});const s=undoStack.pop();cuts=s.cuts;currentCut=s.cc;S.frame=s.f;S.layer=s.li;updateCutList();updateLayerList();updateTimeline();renderAll();}
function redoAction(){if(!redoStack.length)return;undoStack.push({cuts:JSON.parse(JSON.stringify(cuts)),cc:currentCut,f:S.frame,li:S.layer});const s=redoStack.pop();cuts=s.cuts;currentCut=s.cc;S.frame=s.f;S.layer=s.li;updateCutList();updateLayerList();updateTimeline();renderAll();}

// ===========================================================
// ä¿å­˜/èª­è¾¼
// ===========================================================
function getProjectName(){return document.getElementById('project-name-input').value.trim()||'untitled';}
function saveProject(){
  const pn=getProjectName();
  const p={version:2,appName:'StrokeAnimationStudio',projectName:pn,cw:S.cw,ch:S.ch,fps:S.fps,cuts,currentCut,frame:S.frame,layer:S.layer,layerVis,
    frameGuide:{w:frameGuideW,h:frameGuideH,enabled:document.getElementById('frame-guide-enabled').checked}};
  const b=new Blob([JSON.stringify(p)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=pn+'.sasp';a.click();URL.revokeObjectURL(a.href);notify('ä¿å­˜: '+pn+'.sasp');
}
function loadProject(){document.getElementById('file-input-project').click();}
function handleLoadProject(e){
  const f=e.target.files[0];if(!f)return;const rd=new FileReader();rd.onload=ev=>{try{
    const p=JSON.parse(ev.target.result);if(p.appName!=='StrokeAnimationStudio'){notify('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«');return;}
    S.cw=p.cw;S.ch=p.ch;S.fps=p.fps;
    if(p.version>=2){cuts=p.cuts;currentCut=p.currentCut||0;}else{cuts=[{name:'C_001',totalFrames:p.totalFrames,frameDur:p.frameDur||{},layers:p.layers}];currentCut=0;}
    S.frame=p.frame||0;S.layer=p.layer||0;layerVis=p.layerVis||{};
    if(p.projectName)document.getElementById('project-name-input').value=p.projectName;
    document.getElementById('fps-input').value=S.fps;document.getElementById('info-width').value=S.cw;document.getElementById('info-height').value=S.ch;
    if(p.frameGuide){
      frameGuideW=p.frameGuide.w||1920;frameGuideH=p.frameGuide.h||1080;
      document.getElementById('frame-guide-w').value=frameGuideW;
      document.getElementById('frame-guide-h').value=frameGuideH;
      document.getElementById('frame-guide-enabled').checked=!!p.frameGuide.enabled;
    }
    draftImgCache={};createCanvases();centerCanvas();updateCutList();updateLayerList();updateTimeline();renderAll();undoStack=[];redoStack=[];notify('èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  }catch(err){notify('ã‚¨ãƒ©ãƒ¼: '+err.message);}};rd.readAsText(f);e.target.value='';
}

// ===========================================================
// æ–°è¦/ã‚­ãƒ£ãƒ³ãƒã‚¹/ä¸‹æ›¸ã
// ===========================================================
function newProject(){
  if(!confirm('ç¾åœ¨ã®ä½œæ¥­ã‚’ç ´æ£„ã—ã¦æ–°è¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ'))return;
  S.cw=2600;S.ch=1500;S.fps=12;S.frame=0;S.layer=0;cuts=[createEmptyCut('C_001',24)];currentCut=0;
  for(let i=0;i<LAYER_DEFS.length;i++)layerVis[i]=true;undoStack=[];redoStack=[];draftImgCache={};
  document.getElementById('project-name-input').value='untitled';document.getElementById('fps-input').value=S.fps;
  document.getElementById('info-width').value=S.cw;document.getElementById('info-height').value=S.ch;
  frameGuideW=1920;frameGuideH=1080;
  document.getElementById('frame-guide-w').value=1920;document.getElementById('frame-guide-h').value=1080;
  document.getElementById('frame-guide-enabled').checked=true;
  createCanvases();centerCanvas();updateCutList();updateLayerList();updateTimeline();renderAll();notify('æ–°è¦ä½œæˆ');
}
function showCanvasSizeDialog(){document.getElementById('canvas-w-input').value=S.cw;document.getElementById('canvas-h-input').value=S.ch;document.getElementById('canvas-size-modal').classList.add('show');}
function applyCanvasSize(){const w=+document.getElementById('canvas-w-input').value,h=+document.getElementById('canvas-h-input').value;if(w<1||h<1||w>8192||h>8192){notify('ã‚µã‚¤ã‚ºãŒä¸æ­£');return;}pushUndo();S.cw=w;S.ch=h;document.getElementById('info-width').value=w;document.getElementById('info-height').value=h;createCanvases();centerCanvas();renderAll();closeModal('canvas-size-modal');notify(`ã‚­ãƒ£ãƒ³ãƒã‚¹: ${w}Ã—${h}`);}
function applyProjectInfo(){
  const w=+document.getElementById('info-width').value,h=+document.getElementById('info-height').value;
  if(w<1||h<1||w>8192||h>8192){notify('ã‚µã‚¤ã‚ºãŒä¸æ­£');document.getElementById('info-width').value=S.cw;document.getElementById('info-height').value=S.ch;return;}
  pushUndo();S.cw=w;S.ch=h;createCanvases();centerCanvas();renderAll();notify(`ã‚­ãƒ£ãƒ³ãƒã‚¹: ${w}Ã—${h}`);
}
function applyProjectInfoFrames(){
  const nf=+document.getElementById('info-frames').value;
  if(nf<1||nf>9999){notify('ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ãŒä¸æ­£');document.getElementById('info-frames').value=CTF();return;}
  pushUndo();
  const old=CTF();
  if(nf>old){
    for(let i=0;i<LAYER_DEFS.length;i++)for(let f=old;f<nf;f++)CF()[i].frames.push({strokes:[],draftImg:null});
  }else if(nf<old){
    for(let i=0;i<LAYER_DEFS.length;i++)CF()[i].frames.splice(nf);
  }
  CC().totalFrames=nf;
  if(S.frame>=nf)S.frame=nf-1;
  updateTimeline();renderAll();notify(`ãƒ•ãƒ¬ãƒ¼ãƒ æ•°: ${nf}`);
}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function importDraftImage(){if(LAYER_DEFS[S.layer].type!=='draft'){notify('ä¸‹æ›¸ããƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}document.getElementById('file-input-draft').click();}
function handleDraftImage(e){const f=e.target.files[0];if(!f)return;const rd=new FileReader();rd.onload=ev=>{pushUndo();const dataUrl=ev.target.result;CF()[S.layer].frames[S.frame].draftImg=dataUrl;const img=new Image();img.onload=()=>{const key=currentCut+'-'+S.layer+'-'+S.frame;draftImgCache[key]=img;renderAll();notify('ä¸‹æ›¸ãèª­ã¿è¾¼ã¿');};img.src=dataUrl;};rd.readAsDataURL(f);e.target.value='';}

// ===========================================================
// é€£ç•ªPNGå‡ºåŠ›ï¼ˆStarlit Timeline Editoräº’æ›æ–¹å¼ï¼‰
// ===========================================================

async function exportAllPNG(){
  const prog=document.getElementById('export-progress');
  const fill=document.getElementById('export-progress-fill');
  const text=document.getElementById('export-progress-text');
  prog.style.display='block';fill.style.width='0%';

  const zip=new JSZip();const pn=getProjectName();
  let totalCount=0;for(const c of cuts)totalCount+=c.totalFrames;
  let done=0;

  const offscreen=document.createElement('canvas');offscreen.width=S.cw;offscreen.height=S.ch;
  const offCtx=offscreen.getContext('2d');offCtx.imageSmoothingEnabled=false;
  const layerOff=document.createElement('canvas');layerOff.width=S.cw;layerOff.height=S.ch;
  const layerOffCtx=layerOff.getContext('2d');layerOffCtx.imageSmoothingEnabled=false;

  for(let ci=0;ci<cuts.length;ci++){
    const cut=cuts[ci];const cutNum=String(ci+1).padStart(3,'0');
    const cutName='C-'+cutNum;
    const folder=zip.folder(pn+'_'+cutName);
    for(let fi=0;fi<cut.totalFrames;fi++){
      offCtx.clearRect(0,0,S.cw,S.ch);
      for(let li=0;li<LAYER_DEFS.length;li++){
        if(!layerVis[li])continue;layerOffCtx.clearRect(0,0,S.cw,S.ch);
        const isDraft=LAYER_DEFS[li].type==='draft';
        // æŒç¶šãƒ•ãƒ¬ãƒ¼ãƒ å¯¾å¿œ
        const dur=cut.frameDur||{};
        let eidx=fi;
        for(let f=fi;f>=0;f--){const d=dur[li+'-'+f]||1;if(d>1&&fi>=f&&fi<=f+d-1){eidx=f;break;}}
        const fr=cut.layers[li].frames[eidx];if(!fr)continue;
        if(fr.draftImg){await new Promise(res=>{const img=new Image();img.onload=()=>{layerOffCtx.drawImage(img,0,0,S.cw,S.ch);res();};img.src=fr.draftImg;});}
        drawStrokes(layerOffCtx,fr.strokes);if(!isDraft)binarizeCanvas(layerOffCtx,S.cw,S.ch);
        if(isDraft){offCtx.globalAlpha=draftOpacity;offCtx.drawImage(layerOff,0,0);offCtx.globalAlpha=1;}
        else{offCtx.drawImage(layerOff,0,0);}
      }
      const frameNum=String(fi).padStart(4,'0');
      const filename=cutName+'_'+frameNum+'.png';
      const dataUrl=offscreen.toDataURL('image/png');
      const base64Data=dataUrl.split(',')[1];
      folder.file(filename,base64Data,{base64:true});
      done++;fill.style.width=Math.round(done/totalCount*100)+'%';text.textContent=`${done} / ${totalCount}`;
      if(done%4===0)await new Promise(r=>setTimeout(r,10));
    }
  }
  text.textContent='ZIPåœ§ç¸®ä¸­...';
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=pn+'_png.zip';
  a.click();
  URL.revokeObjectURL(a.href);
  prog.style.display='none';notify(`${totalCount}æšã®PNGã‚’ZIPå‡ºåŠ›`);
}

// ===========================================================
function notify(msg){const el=document.getElementById('notification');el.textContent=msg;el.style.display='block';clearTimeout(el._t);el._t=setTimeout(()=>{el.style.display='none';},2500);}
window.addEventListener('load',init);
</script>
</body>
</html>
