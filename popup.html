<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  background:#111;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#imageContainer{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  overflow:hidden;
  position:relative;
}
img{
  max-width:100%;
  max-height:100%;
}
#controls{
  padding:8px;
  background:#1a1a2e;
  width:100%;
  box-sizing:border-box;
  display:flex;
  gap:8px;
  justify-content:center;
  align-items:center;
}
button{
  padding:6px 12px;
  background:#4a9eff;
  color:#fff;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:14px;
  min-width:40px;
}
button:hover{
  background:#3a8eef;
}
button:active{
  background:#2a7edf;
}
button:disabled{
  background:#333;
  color:#666;
  cursor:not-allowed;
}
#status{
  padding:4px 8px;
  background:#2a2a3e;
  color:#aaa;
  font-size:12px;
  border-radius:3px;
}
#libraryBtn{
  font-size:16px;
  padding:6px 10px;
}

/* ÁîªÂÉè„É©„Ç§„Éñ„É©„É™„É¢„Éº„ÉÄ„É´ */
#libraryModal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  z-index:1000;
  align-items:center;
  justify-content:center;
}
#libraryModal.show{
  display:flex;
}
#libraryContent{
  background:#1a1a2e;
  border-radius:8px;
  width:80%;
  max-width:600px;
  max-height:80%;
  display:flex;
  flex-direction:column;
}
#libraryHeader{
  padding:12px 16px;
  background:#2a2a3e;
  border-radius:8px 8px 0 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:#fff;
  font-weight:bold;
}
#libraryClose{
  background:#ff4a4a;
  padding:4px 12px;
  font-size:12px;
}
#libraryBody{
  padding:16px;
  overflow-y:auto;
  flex:1;
}
#libraryGrid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(80px, 1fr));
  gap:8px;
}
.library-item{
  position:relative;
  aspect-ratio:1;
  border:2px solid transparent;
  border-radius:4px;
  overflow:hidden;
  cursor:pointer;
  background:#2a2a3e;
}
.library-item:hover{
  border-color:#4a9eff;
}
.library-item.selected{
  border-color:#4a9eff;
  box-shadow:0 0 10px rgba(74,158,255,0.5);
}
.library-item img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.library-item-index{
  position:absolute;
  top:2px;
  left:2px;
  background:rgba(0,0,0,0.7);
  color:#fff;
  padding:1px 4px;
  border-radius:2px;
  font-size:9px;
}
#libraryActions{
  padding:12px 16px;
  background:#2a2a3e;
  border-radius:0 0 8px 8px;
  display:flex;
  gap:8px;
  justify-content:flex-end;
}
#deleteBtn{
  background:#ff4a4a;
}
#deleteBtn:hover{
  background:#ef3a3a;
}
#deleteBtn:disabled{
  background:#333;
  color:#666;
}
</style>
</head>
<body>

<div id="imageContainer">
  <img id="img">
</div>

<div id="controls">
  <button id="prevBtn" disabled>‚óÅ</button>
  <div id="status">ÁîªÂÉè„Å™„Åó</div>
  <button id="nextBtn" disabled>‚ñ∑</button>
  <button id="libraryBtn">üìñ</button>
  <button id="eyedropperBtn" title="„Çπ„Éù„Ç§„ÉàÔºà„É°„Ç§„É≥„Ç≠„É£„É≥„Éê„Çπ„Åã„ÇâËâ≤„ÇíÂèñÂæóÔºâ">üíß</button>
</div>

<!-- ÁîªÂÉè„É©„Ç§„Éñ„É©„É™„É¢„Éº„ÉÄ„É´ -->
<div id="libraryModal">
  <div id="libraryContent">
    <div id="libraryHeader">
      <span>ÁîªÂÉè„É©„Ç§„Éñ„É©„É™</span>
      <button id="libraryClose">Èñâ„Åò„Çã</button>
    </div>
    <div id="libraryBody">
      <div id="libraryGrid"></div>
    </div>
    <div id="libraryActions">
      <button id="deleteBtn" disabled>üóëÔ∏è ÂâäÈô§</button>
    </div>
  </div>
</div>

<script>
let currentIndex = 0;
let images = [];
let projectId = '';
let selectedLibraryIndex = -1;

const img = document.getElementById('img');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const status = document.getElementById('status');
const libraryBtn = document.getElementById('libraryBtn');
const libraryModal = document.getElementById('libraryModal');
const libraryClose = document.getElementById('libraryClose');
const libraryGrid = document.getElementById('libraryGrid');
const deleteBtn = document.getElementById('deleteBtn');

window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(location.search);
  projectId = params.get('project');
  
  loadImages();
  updateDisplay();
});

function loadImages() {
  const key = `project:${projectId}:images`;
  images = JSON.parse(localStorage.getItem(key)) || [];
}

function saveImages() {
  const key = `project:${projectId}:images`;
  localStorage.setItem(key, JSON.stringify(images));
  
  // Ë¶™„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´ÁîªÂÉèÊõ¥Êñ∞„ÇíÈÄöÁü•
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({
      type: 'updatePopupImages',
      images: images,
      projectId: projectId
    }, '*');
  }
}

function updateDisplay() {
  if (images.length === 0) {
    img.src = '';
    status.textContent = 'ÁîªÂÉè„Å™„Åó';
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    return;
  }
  
  // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆÁØÑÂõ≤„ÉÅ„Çß„ÉÉ„ÇØ
  if (currentIndex >= images.length) {
    currentIndex = images.length - 1;
  }
  if (currentIndex < 0) {
    currentIndex = 0;
  }
  
  img.src = images[currentIndex];
  status.textContent = `${currentIndex + 1} / ${images.length}`;
  
  prevBtn.disabled = currentIndex === 0;
  nextBtn.disabled = currentIndex === images.length - 1;
}

prevBtn.addEventListener('click', () => {
  if (currentIndex > 0) {
    currentIndex--;
    updateDisplay();
  }
});

nextBtn.addEventListener('click', () => {
  if (currentIndex < images.length - 1) {
    currentIndex++;
    updateDisplay();
  }
});

libraryBtn.addEventListener('click', () => {
  openLibrary();
});

libraryClose.addEventListener('click', () => {
  closeLibrary();
});

libraryModal.addEventListener('click', (e) => {
  if (e.target === libraryModal) {
    closeLibrary();
  }
});

function openLibrary() {
  selectedLibraryIndex = -1;
  renderLibrary();
  libraryModal.classList.add('show');
}

function closeLibrary() {
  libraryModal.classList.remove('show');
}

function renderLibrary() {
  libraryGrid.innerHTML = '';
  
  if (images.length === 0) {
    libraryGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">ÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    deleteBtn.disabled = true;
    return;
  }
  
  images.forEach((imgData, index) => {
    const item = document.createElement('div');
    item.className = 'library-item';
    if (index === selectedLibraryIndex) {
      item.classList.add('selected');
    }
    
    const imgEl = document.createElement('img');
    imgEl.src = imgData;
    
    const indexLabel = document.createElement('div');
    indexLabel.className = 'library-item-index';
    indexLabel.textContent = index + 1;
    
    item.appendChild(imgEl);
    item.appendChild(indexLabel);
    
    item.addEventListener('click', () => {
      selectLibraryItem(index);
    });
    
    libraryGrid.appendChild(item);
  });
  
  deleteBtn.disabled = selectedLibraryIndex === -1;
}

function selectLibraryItem(index) {
  if (selectedLibraryIndex === index) {
    // Âêå„Åò„ÇÇ„ÅÆ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈÅ∏ÊäûËß£Èô§
    selectedLibraryIndex = -1;
  } else {
    selectedLibraryIndex = index;
  }
  renderLibrary();
}

deleteBtn.addEventListener('click', () => {
  if (selectedLibraryIndex === -1) return;
  
  if (confirm(`ÁîªÂÉè ${selectedLibraryIndex + 1} „ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
    images.splice(selectedLibraryIndex, 1);
    saveImages();
    
    // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆÁîªÂÉè„ÅåÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà
    if (currentIndex === selectedLibraryIndex) {
      if (currentIndex >= images.length) {
        currentIndex = Math.max(0, images.length - 1);
      }
      updateDisplay(); // ‚òÖ „É°„Ç§„É≥ÁîªÈù¢„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
    } else if (currentIndex > selectedLibraryIndex) {
      currentIndex--;
      updateDisplay(); // ‚òÖ „É°„Ç§„É≥ÁîªÈù¢„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
    } else {
      updateDisplay(); // ‚òÖ Êï∞ÂÄ§„ÇíÊõ¥Êñ∞„Åô„Çã„Åü„ÇÅ„Å´ËøΩÂä†
    }
    
    selectedLibraryIndex = -1;
    renderLibrary();
  }
});

// Ë¶™„Ç¶„Ç£„É≥„Éâ„Ç¶„Åã„Çâ„ÅÆÁîªÂÉèÊõ¥Êñ∞„ÇíÂèó‰ø°
window.addEventListener('message', (event) => {
  if (event.data.type === 'imageAdded') {
    loadImages();
    currentIndex = images.length - 1; // ÊúÄÊñ∞ÁîªÂÉè„ÇíË°®Á§∫
    updateDisplay();
  }
});

// Êó¢Â≠ò„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„ÅÆÊú´Â∞æ„ÅÇ„Åü„Çä„Å´ËøΩÂä†
const eyedropperBtn = document.getElementById('eyedropperBtn');

eyedropperBtn.addEventListener('click', () => {
  // Ë¶™„Ç¶„Ç£„É≥„Éâ„Ç¶Ôºàindex.htmlÔºâ„Å´„Äå„Çπ„Éù„Ç§„ÉàÈñãÂßã„Äç„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ„Çã
  window.parent.postMessage({
    type: 'requestEyedropper'
  }, '*');

  // „Éú„Çø„É≥„Çí‰∏ÄÊôÇÁöÑ„Å´Êäº„Åó„ÅüÊÑü„Åò„Å´„Åô„ÇãÔºà‰ªªÊÑèÔºâ
  eyedropperBtn.style.background = '#ff6b81';
  setTimeout(() => {
    eyedropperBtn.style.background = '';
  }, 200);
});
</script>

</body>
</html>
