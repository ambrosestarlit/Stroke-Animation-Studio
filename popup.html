<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  background:#111;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#imageContainer{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  width:100%;
  overflow:hidden;
  position:relative;
  touch-action:none;          /* â† è¿½åŠ ï¼šãƒ¢ãƒã‚¤ãƒ«ã®äºˆæœŸã›ã¬å‹•ä½œé˜²æ­¢ */
  cursor:grab;                /* â† è¿½åŠ ï¼šãƒ‘ãƒ³å¯èƒ½ãªè¦‹ãŸç›® */
}
#imageContainer.grabbing{
  cursor:grabbing;
}
img{
  max-width:100%;
  max-height:100%;
}
#controls{
  padding:8px;
  background:#1a1a2e;
  width:100%;
  box-sizing:border-box;
  display:flex;
  gap:8px;
  justify-content:center;
  align-items:center;
}
button{
  padding:6px 12px;
  background:#4a9eff;
  color:#fff;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:14px;
  min-width:40px;
}
button:hover{
  background:#3a8eef;
}
button:active{
  background:#2a7edf;
}
button:disabled{
  background:#333;
  color:#666;
  cursor:not-allowed;
}
#status{
  padding:4px 8px;
  background:#2a2a3e;
  color:#aaa;
  font-size:12px;
  border-radius:3px;
}
#libraryBtn{
  font-size:16px;
  padding:6px 10px;
}

/* ç”»åƒãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…ƒã®ã¾ã¾ï¼‰ */
#libraryModal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  z-index:1000;
  align-items:center;
  justify-content:center;
}
#libraryModal.show{
  display:flex;
}
#libraryContent{
  background:#1a1a2e;
  border-radius:8px;
  width:80%;
  max-width:600px;
  max-height:80%;
  display:flex;
  flex-direction:column;
}
#libraryHeader{
  padding:12px 16px;
  background:#2a2a3e;
  border-radius:8px 8px 0 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:#fff;
  font-weight:bold;
}
#libraryClose{
  background:#ff4a4a;
  padding:4px 12px;
  font-size:12px;
}
#libraryBody{
  padding:16px;
  overflow-y:auto;
  flex:1;
}
#libraryGrid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(80px, 1fr));
  gap:8px;
}
.library-item{
  position:relative;
  aspect-ratio:1;
  border:2px solid transparent;
  border-radius:4px;
  overflow:hidden;
  cursor:pointer;
  background:#2a2a3e;
}
.library-item:hover{
  border-color:#4a9eff;
}
.library-item.selected{
  border-color:#4a9eff;
  box-shadow:0 0 10px rgba(74,158,255,0.5);
}
.library-item img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.library-item-index{
  position:absolute;
  top:2px;
  left:2px;
  background:rgba(0,0,0,0.7);
  color:#fff;
  padding:1px 4px;
  border-radius:2px;
  font-size:9px;
}
#libraryActions{
  padding:12px 16px;
  background:#2a2a3e;
  border-radius:0 0 8px 8px;
  display:flex;
  gap:8px;
  justify-content:flex-end;
}
#deleteBtn{
  background:#ff4a4a;
}
#deleteBtn:hover{
  background:#ef3a3a;
}
#deleteBtn:disabled{
  background:#333;
  color:#666;
}

/* â”€â”€ ã“ã“ã‹ã‚‰è¿½åŠ  â”€â”€ ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ */
#transformWrapper {
  position: absolute;
  top: 0; left: 0;
  will-change: transform;
  transform-origin: 0 0;          /* å·¦ä¸ŠåŸºæº–ã§ã‚¹ã‚±ãƒ¼ãƒ« */
}

/* img ã‚’ max-width/height ã‹ã‚‰å¤–ã—ã¦è‡ªç”±ã«æ‹¡å¤§å¯èƒ½ã« */
#transformWrapper img {
  display: block;
  width: auto;
  height: auto;
  max-width: none;
  max-height: none;
  pointer-events: none;
}

#imageContainer {
    touch-action: none;           /* ã“ã‚ŒãŒè¶…é‡è¦ï¼ */
    -webkit-user-select: none;
    user-select: none;
  }
  #transformWrapper {
    will-change: transform;
    transform-origin: 0 0;
  }
  img {
    pointer-events: none;         /* imgè‡ªä½“ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€šã•ãªã„ */
  }
</style>
</head>
<body>

<div id="imageContainer">
  <div id="transformWrapper">
    <img id="img">
  </div>
</div>

<div id="controls">
  <button id="prevBtn" disabled>â—</button>
  <div id="status">ç”»åƒãªã—</div>
  <button id="nextBtn" disabled>â–·</button>
  <button id="libraryBtn">ğŸ“–</button>
  <button id="eyedropperBtn" title="ã‚¹ãƒã‚¤ãƒˆï¼ˆãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰è‰²ã‚’å–å¾—ï¼‰">ğŸ’§</button>
</div>

<!-- ç”»åƒãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…ƒã®ã¾ã¾ï¼‰ -->
<div id="libraryModal">
  <div id="libraryContent">
    <div id="libraryHeader">
      <span>ç”»åƒãƒ©ã‚¤ãƒ–ãƒ©ãƒª</span>
      <button id="libraryClose">é–‰ã˜ã‚‹</button>
    </div>
    <div id="libraryBody">
      <div id="libraryGrid"></div>
    </div>
    <div id="libraryActions">
      <button id="deleteBtn" disabled>ğŸ—‘ï¸ å‰Šé™¤</button>
    </div>
  </div>
</div>

<script>
let currentIndex = 0;
let images = [];
let projectId = '';
let selectedLibraryIndex = -1;

// â”€â”€ ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ç”¨å¤‰æ•°ï¼ˆã“ã“ã‹ã‚‰è¿½åŠ ï¼‰ â”€â”€
let scale = 1;
let translateX = 0;
let translateY = 0;
let isDragging = false;
let isPinching = false;
let startX = 0, startY = 0;
let startTranslateX = 0, startTranslateY = 0;
let startPinchDist = 0;
let startScale = 1;
let pinchCenterX = 0, pinchCenterY = 0;

// â”€â”€ ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã“ã“ãŒãƒ¡ã‚¤ãƒ³ã®è¿½åŠ éƒ¨åˆ†ï¼‰ â”€â”€
function setupViewEvents() {
  // ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ï¼ˆãƒã‚¦ã‚¹ä½ç½®ä¸­å¿ƒï¼‰
  container.addEventListener('wheel', e => {
    e.preventDefault();
    if (images.length === 0) return;

    const rect = container.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const oldScale = scale;
    scale = Math.max(0.2, Math.min(8, scale * (e.deltaY < 0 ? 1.15 : 0.85)));

    const ratio = scale / oldScale;
    translateX = mx - (mx - translateX) * ratio;
    translateY = my - (my - translateY) * ratio;

    applyTransform();
  }, { passive: false });

const img = document.getElementById('img');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const status = document.getElementById('status');
const libraryBtn = document.getElementById('libraryBtn');
const libraryModal = document.getElementById('libraryModal');
const libraryClose = document.getElementById('libraryClose');
const libraryGrid = document.getElementById('libraryGrid');
const deleteBtn = document.getElementById('deleteBtn');
const container = document.getElementById('imageContainer');
const wrapper = document.getElementById('transformWrapper');

window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(location.search);
  projectId = params.get('project');
  
  loadImages();
  updateDisplay();
  setupViewEvents();           // â† è¿½åŠ ï¼šã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
});

// â”€â”€ ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæœ€å„ªå…ˆï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let prevTouches = [];

function loadImages() {
  const key = `project:${projectId}:images`;
  images = JSON.parse(localStorage.getItem(key)) || [];
}

function saveImages() {
  const key = `project:${projectId}:images`;
  localStorage.setItem(key, JSON.stringify(images));
  
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({
      type: 'updatePopupImages',
      images: images,
      projectId: projectId
    }, '*');
  }
}

function updateDisplay() {
  if (images.length === 0) {
    img.src = '';
    status.textContent = 'ç”»åƒãªã—';
    prevBtn.disabled = true;
    nextBtn.disabled = true;
    resetView();               // â† è¿½åŠ 
    return;
  }
  
  if (currentIndex >= images.length) currentIndex = images.length - 1;
  if (currentIndex < 0) currentIndex = 0;

  img.src = images[currentIndex];
  status.textContent = `${currentIndex + 1} / ${images.length}`;
  
  prevBtn.disabled = currentIndex === 0;
  nextBtn.disabled = currentIndex === images.length - 1;

  resetView();                 // â† ç”»åƒãŒå¤‰ã‚ã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
}

function resetView() {
  scale = 1;
  translateX = translateY = 0;
  applyTransform();
}

function applyTransform() {
  wrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
}



  // ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³
  container.addEventListener('pointerdown', e => {
  // å·¦ã‚¯ãƒªãƒƒã‚¯ or 1æœ¬æŒ‡ã‚¿ãƒƒãƒ â†’ ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
  if (e.pointerType === 'mouse' && e.button !== 0) return;
  if (images.length === 0) return;

  // æ—¢ã«ãƒ‰ãƒ©ãƒƒã‚°ä¸­ãªã‚‰ç„¡è¦–ï¼ˆå¤šç‚¹ã‚¿ãƒƒãƒå¯¾ç­–ï¼‰
  if (isDragging) return;

  isDragging = true;
  startX = e.clientX;
  startY = e.clientY;
  startTranslateX = translateX;
  startTranslateY = translateY;

  container.classList.add('grabbing');
  e.preventDefault();
});

window.addEventListener('pointermove', e => {
  if (!isDragging && !isPinching) return;

  if (isPinching) {
    // ãƒ”ãƒ³ãƒå‡¦ç†ã¯å¾Œè¿°
    return;
  }

  const dx = e.clientX - startX;
  const dy = e.clientY - startY;

  translateX = startTranslateX + dx;
  translateY = startTranslateY + dy;

  applyTransform();
});

window.addEventListener('pointerup', () => {
  isDragging = false;
  container.classList.remove('grabbing');
});

// â”€â”€ ãƒãƒ«ãƒã‚¿ãƒƒãƒï¼ˆãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ï¼‰å°‚ç”¨å‡¦ç† â”€â”€
container.addEventListener('touchstart', e => {
  e.preventDefault();
  prevTouches = Array.from(e.touches);
  
  if (e.touches.length === 2) {
    // 2æœ¬æŒ‡ â†’ ãƒ”ãƒ³ãƒé–‹å§‹
    isPinching = true;
    isDragging = false; // ãƒ‰ãƒ©ãƒƒã‚°ã‚’å¼·åˆ¶çµ‚äº†

    const t1 = e.touches[0];
    const t2 = e.touches[1];

    startPinchDist = Math.hypot(
      t1.clientX - t2.clientX,
      t1.clientY - t2.clientY
    );

    startScale = scale;

    // ãƒ”ãƒ³ãƒä¸­å¿ƒï¼ˆ2ç‚¹ã®ä¸­ç‚¹ï¼‰
    pinchCenterX = (t1.clientX + t2.clientX) / 2;
    pinchCenterY = (t1.clientY + t2.clientY) / 2;

    
  }
}, { passive: false });

container.addEventListener('touchmove', e => {
  if (e.touches.length !== 2 || !isPinching) return;

  const t1 = e.touches[0];
  const t2 = e.touches[1];

  const currentDist = Math.hypot(
    t1.clientX - t2.clientX,
    t1.clientY - t2.clientY
  );

  // ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—ï¼ˆãƒ”ãƒ³ãƒä¸­å¿ƒåŸºæº–ï¼‰
  const newScale = startScale * (currentDist / startPinchDist);
  scale = Math.max(0.2, Math.min(8, newScale));

  // ãƒ”ãƒ³ãƒä¸­å¿ƒã‚’åŸºæº–ã«ãƒ‘ãƒ³è£œæ­£
  const cx = pinchCenterX;
  const cy = pinchCenterY;

  const ratio = scale / startScale;
  translateX = cx - (cx - translateX) * ratio;
  translateY = cy - (cy - translateY) * ratio;

  applyTransform();

  e.preventDefault();
}, { passive: false });

container.addEventListener('touchend', e => {
  if (e.touches.length < 2) {
    isPinching = false;
  }
});

// â”€â”€ ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ä¾¿åˆ©ï¼‰ â”€â”€
let lastTap = 0;
container.addEventListener('touchend', e => {
  const now = Date.now();
  if (now - lastTap < 300) { // 300msä»¥å†…ãªã‚‰ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—
    resetView();
  }
  lastTap = now;
});
  // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒªã‚»ãƒƒãƒˆï¼ˆä¾¿åˆ©ãªã®ã§è¿½åŠ ï¼‰
  container.addEventListener('dblclick', resetView);
}

// â”€â”€ ä»¥ä¸‹ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ãªã—ï¼‰ â”€â”€
prevBtn.addEventListener('click', () => {
  if (currentIndex > 0) {
    currentIndex--;
    updateDisplay();
  }
});

nextBtn.addEventListener('click', () => {
  if (currentIndex < images.length - 1) {
    currentIndex++;
    updateDisplay();
  }
});

libraryBtn.addEventListener('click', openLibrary);

libraryClose.addEventListener('click', closeLibrary);

libraryModal.addEventListener('click', (e) => {
  if (e.target === libraryModal) closeLibrary();
});

function openLibrary() {
  selectedLibraryIndex = -1;
  renderLibrary();
  libraryModal.classList.add('show');
}

function closeLibrary() {
  libraryModal.classList.remove('show');
}

function renderLibrary() {
  libraryGrid.innerHTML = '';
  
  if (images.length === 0) {
    libraryGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#666;padding:20px;">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</div>';
    deleteBtn.disabled = true;
    return;
  }
  
  images.forEach((imgData, index) => {
    const item = document.createElement('div');
    item.className = 'library-item';
    if (index === selectedLibraryIndex) item.classList.add('selected');
    
    const imgEl = document.createElement('img');
    imgEl.src = imgData;
    
    const indexLabel = document.createElement('div');
    indexLabel.className = 'library-item-index';
    indexLabel.textContent = index + 1;
    
    item.appendChild(imgEl);
    item.appendChild(indexLabel);
    
    item.addEventListener('click', () => {
      selectLibraryItem(index);
    });
    
    libraryGrid.appendChild(item);
  });
  
  deleteBtn.disabled = selectedLibraryIndex === -1;
}

function selectLibraryItem(index) {
  selectedLibraryIndex = (selectedLibraryIndex === index) ? -1 : index;
  renderLibrary();
}

deleteBtn.addEventListener('click', () => {
  if (selectedLibraryIndex === -1) return;
  
  if (confirm(`ç”»åƒ ${selectedLibraryIndex + 1} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
    images.splice(selectedLibraryIndex, 1);
    saveImages();
    
    if (currentIndex === selectedLibraryIndex) {
      currentIndex = Math.max(0, images.length - 1);
    } else if (currentIndex > selectedLibraryIndex) {
      currentIndex--;
    }
    updateDisplay();
    
    selectedLibraryIndex = -1;
    renderLibrary();
  }
});

// è¦ªã‹ã‚‰ã®ç”»åƒè¿½åŠ é€šçŸ¥
window.addEventListener('message', (event) => {
  if (event.data.type === 'imageAdded') {
    loadImages();
    currentIndex = images.length - 1;
    updateDisplay();
  }
});

// ã‚¹ãƒã‚¤ãƒˆãƒœã‚¿ãƒ³
eyedropperBtn.addEventListener('click', () => {
  window.parent.postMessage({ type: 'requestEyedropper' }, '*');
  eyedropperBtn.style.background = '#ff6b81';
  setTimeout(() => eyedropperBtn.style.background = '', 200);
});
</script>
</body>
</html>